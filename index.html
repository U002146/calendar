<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>google calendar</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --primary: #06c755; --primary-dark: #05a546; --bg: #f5f5f5; --text: #333; --gray-border: #ddd; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: var(--bg); padding: 20px; color: var(--text); -webkit-tap-highlight-color: transparent; }
        
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        h2 { text-align: center; margin-top: 0; color: #111; font-weight: 700; }

        .row { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 1rem; color: #444; }
        
        input, select, button { width: 100%; padding: 12px; border: 1px solid var(--gray-border); border-radius: 10px; font-size: 1rem; box-sizing: border-box; transition: all 0.2s; }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(6, 199, 85, 0.1); }
        
        /* === NEW: æ—¥æœŸæŒ‰éˆ•é¸æ“‡å™¨æ¨£å¼ === */
        .date-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 5px;
        }
        .date-btn {
            padding: 10px 5px;
            background: white;
            border: 1px solid var(--gray-border);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 70px;
        }
        .date-btn .day-num { font-size: 1.2rem; font-weight: bold; line-height: 1.2; }
        .date-btn .day-text { font-size: 0.8rem; color: #666; margin-top: 2px; }
        
        /* é¸ä¸­ç‹€æ…‹ */
        .date-btn.active {
            background-color: var(--primary);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(6, 199, 85, 0.3);
        }
        .date-btn.active .day-text { color: rgba(255,255,255,0.9); }
        
        /* éš±è—åŸæœ¬çš„ inputï¼Œä½†ä¿ç•™åŠŸèƒ½é‚è¼¯ */
        #dateData { display: none; }
        /* ================================ */

        .location-group { display: flex; gap: 8px; }
        .btn-map { background: #f0f0f0; color: #333; border: none; width: auto; white-space: nowrap; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 4px; padding: 0 15px; }
        .btn-map:active { background: #e0e0e0; }

        .hint { font-size: 0.85rem; color: #888; margin-top: 6px; display: flex; align-items: flex-start; gap: 4px; }

        .btn-submit { background: var(--primary); color: white; font-size: 1.2rem; font-weight: bold; border: none; margin-top: 15px; cursor: pointer; padding: 14px; border-radius: 50px; box-shadow: 0 4px 15px rgba(6, 199, 85, 0.3); }
        .btn-submit:active { transform: scale(0.98); }
        .btn-submit:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }

        /* Modal Styles */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: flex-end; }
        .modal-content { background: white; width: 100%; border-radius: 20px 20px 0 0; padding: 25px 20px; animation: slideUp 0.3s; max-height: 80vh; overflow-y: auto; }
        .tag-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .tag { padding: 8px 16px; background: #f8f9fa; border-radius: 20px; font-size: 0.95rem; cursor: pointer; border: 1px solid #eee; transition: background 0.2s; }
        .tag.saved { background: #e3f2fd; color: #0d47a1; border-color: #bbdefb; }
        .tag:active { background: #e0e0e0; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-btn { font-size: 1.8rem; background: none; border: none; width: auto; padding: 0 10px; color: #999; }
        
        .edit-btn { background: none; border: 1px solid #ddd; padding: 4px 10px; font-size: 0.8rem; border-radius: 12px; margin-left: 5px; color: #666; width: auto; }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h2>æ­¡è¿é ç´„</h2>
    
    <!-- æ—¥æœŸé¸æ“‡å€å¡Š (UI æ›´æ–°) -->
    <div class="row">
        <label>é¸æ“‡æ—¥æœŸ</label>
        <div class="date-selector" id="dateButtonsContainer">
            <!-- JavaScript æœƒåœ¨é€™è£¡ç”¢ç”Ÿ 4 å€‹æŒ‰éˆ• -->
        </div>
        <!-- éš±è—çš„ input ç”¨ä¾†å­˜æ”¾é¸ä¸­çš„å®Œæ•´æ—¥æœŸ YYYY-MM-DD -->
        <input type="text" id="dateData" readonly>
    </div>

    <!-- æ™‚é–“é¸æ“‡ -->
    <div class="row">
        <label>æ™‚é–“</label>
        <input type="time" id="timeData">
    </div>

    <!-- åœ°é»é¸æ“‡ -->
    <div class="row">
        <label>ä¸Šè»Šåœ°é»</label>
        <div class="location-group">
            <input type="text" id="locationData" placeholder="è«‹è¼¸å…¥æˆ–é¸æ“‡åœ°é»">
            <button type="button" class="btn-map" onclick="openLocationModal()">ğŸ“ é¸æ“‡</button>
        </div>
    </div>

    <!-- é›»è©± (é¸å¡«) -->
    <div class="row">
        <label>è¯çµ¡é›»è©± <span style="font-size:0.9rem; font-weight:normal; color:#666;">(é¸å¡«)</span></label>
        <input type="tel" id="phoneData" placeholder="09xx...">
        <div class="hint">
            <span>ğŸ’¡</span>
            <span>æœ¬äººæ­è»Šå…å¡«ï¼Œå¹«è¦ªå‹å«è»Šè«‹å¡«å¯«å°æ–¹è™Ÿç¢¼ã€‚</span>
        </div>
    </div>

    <button id="submitBtn" class="btn-submit" onclick="submitBooking()">ç¢ºèªé ç´„</button>
</div>

<!-- åœ°é»é¸æ“‡ Modal -->
<div id="locationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin:0;">å¸¸ç”¨åœ°é»</h3>
            <button class="close-btn" onclick="closeLocationModal()">Ã—</button>
        </div>
        
        <p style="font-weight:bold; color:#666; margin-bottom:10px;">æˆ‘çš„æœ€æ„›</p>
        <div style="display:flex; align-items:center; margin-bottom:10px;">
            <div class="tag saved" id="favA" onclick="selectLocation(this.innerText)" style="flex:1; text-align:center;">è‡ªå®¶: (é»æ­¤ç·¨è¼¯)</div>
            <button class="edit-btn" onclick="editFavorite('favA')">âœï¸</button>
        </div>
        <div style="display:flex; align-items:center; margin-bottom:15px;">
            <div class="tag saved" id="favB" onclick="selectLocation(this.innerText)" style="flex:1; text-align:center;">å…¬å¸: (é»æ­¤ç·¨è¼¯)</div>
            <button class="edit-btn" onclick="editFavorite('favB')">âœï¸</button>
        </div>
        
        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
        
        <p style="font-weight:bold; color:#666; margin-bottom:10px;">ç†±é–€åœ°æ¨™</p>
        <div class="tag-group">
            <div class="tag" onclick="selectLocation('èŠ±è“®ç«è»Šç«™(å‰ç«™)')">èŠ±è“®å‰ç«™</div>
            <div class="tag" onclick="selectLocation('èŠ±è“®ç«è»Šç«™(å¾Œç«™)')">èŠ±è“®å¾Œç«™</div>
            <div class="tag" onclick="selectLocation('æ…ˆæ¿Ÿé†«é™¢(é–€è¨º)')">æ…ˆæ¿Ÿé–€è¨º</div>
            <div class="tag" onclick="selectLocation('æ…ˆæ¿Ÿé†«é™¢(æ€¥è¨º)')">æ…ˆæ¿Ÿæ€¥è¨º</div>
            <div class="tag" onclick="selectLocation('é–€è«¾é†«é™¢(é–€è¨º)')">é–€è«¾é–€è¨º</div>
            <div class="tag" onclick="selectLocation('é–€è«¾é†«é™¢(æ€¥è¨º)')">é–€è«¾æ€¥è¨º</div>
            <div class="tag" onclick="selectLocation('éƒ¨ç«‹èŠ±è“®é†«é™¢')">èŠ±è“®é†«é™¢</div>
            <div class="tag" onclick="selectLocation('åœ‹è»805é†«é™¢')">805é†«é™¢</div>
        </div>
    </div>
</div>

<script>
    // ä½ çš„è¨­å®šæª”
    const LIFF_ID = '2008907691-x4s1XueL'; 
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwODDCmwAggIyan3gxJJazGd3fWR9N2JsBk04OBQfyQ6SPjduhbQIEg_B_GZWH2Uex7/exec'; 

    window.onload = function() {
        initLiff();
        loadFavorites();
        initDateButtons(); // åˆå§‹åŒ–æ—¥æœŸæŒ‰éˆ•
    };

    function initLiff() {
        liff.init({ liffId: LIFF_ID }).then(() => {
            if (!liff.isLoggedIn()) {
                liff.login();
            }
        }).catch(err => {
            console.error('LIFF Init Error', err);
        });
    }

    // === NEW: ç”¢ç”Ÿ 4 å¤©æ—¥æœŸæŒ‰éˆ•é‚è¼¯ ===
    function initDateButtons() {
        const container = document.getElementById('dateButtonsContainer');
        const hiddenInput = document.getElementById('dateData');
        const weekDays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
        
        container.innerHTML = ''; // æ¸…ç©º
        
        for (let i = 0; i < 4; i++) {
            const d = new Date();
            d.setDate(d.getDate() + i);
            
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const date = String(d.getDate()).padStart(2, '0');
            const dayOfWeek = d.getDay();
            
            const fullDateStr = `${year}-${month}-${date}`;
            
            // æ±ºå®šé¡¯ç¤ºæ–‡å­— (ä»Šå¤©/æ˜å¤©/å¾Œå¤©/é€±X)
            let labelText = weekDays[dayOfWeek];
            if (i === 1) labelText = 'æ˜å¤©';
            if (i === 2) labelText = 'å¾Œå¤©';
            // å¦‚æœéœ€è¦ "ä»Šå¤©"ï¼Œå¯ä»¥åœ¨ i===0 æ™‚è¨­å®šï¼Œä½†é€šå¸¸é¡¯ç¤ºé€±å¹¾æ¯”è¼ƒæ¸…æ¥š
            
            const btn = document.createElement('div');
            btn.className = 'date-btn';
            if (i === 0) btn.classList.add('active'); // é è¨­é¸ä¸­ç¬¬ä¸€å¤©
            btn.innerHTML = `<span class="day-num">${parseInt(date)}è™Ÿ</span><span class="day-text">${labelText}</span>`;
            
            // é»æ“Šäº‹ä»¶
            btn.onclick = function() {
                // ç§»é™¤æ‰€æœ‰ active
                document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
                // è‡ªå·±åŠ ä¸Š active
                this.classList.add('active');
                // æ›´æ–°éš±è— input å€¼
                hiddenInput.value = fullDateStr;
            };

            container.appendChild(btn);

            // åˆå§‹åŒ–ç¬¬ä¸€å¤©çš„å€¼
            if (i === 0) {
                hiddenInput.value = fullDateStr;
            }
        }
    }
    // ===================================

    function openLocationModal() { document.getElementById('locationModal').style.display = 'flex'; }
    function closeLocationModal() { document.getElementById('locationModal').style.display = 'none'; }
    
    function selectLocation(text) {
        let address = text.includes(':') ? text.split(':')[1].trim() : text;
        if(address.includes('(é»æ­¤ç·¨è¼¯)')) address = ""; 
        document.getElementById('locationData').value = address;
        closeLocationModal();
    }

    function loadFavorites() {
        const a = localStorage.getItem('taxi_fav_A');
        const b = localStorage.getItem('taxi_fav_B');
        if (a) document.getElementById('favA').innerText = a;
        if (b) document.getElementById('favB').innerText = b;
    }

    function editFavorite(key) {
        const currentText = document.getElementById(key).innerText;
        // ç°¡å–®è™•ç†ï¼Œåªå–åœ°å€éƒ¨åˆ†
        let currentVal = currentText.includes(':') ? currentText.split(':')[1].trim() : '';
        if(currentVal.includes('(é»æ­¤ç·¨è¼¯)')) currentVal = '';

        Swal.fire({
            title: 'ç·¨è¼¯å¸¸ç”¨åœ°å€',
            input: 'text',
            inputValue: currentVal,
            placeholder: 'ä¾‹å¦‚ï¼šèŠ±è“®å¸‚ä¸­å±±è·¯100è™Ÿ',
            showCancelButton: true,
            confirmButtonText: 'å„²å­˜',
            cancelButtonText: 'å–æ¶ˆ',
            confirmButtonColor: '#06c755'
        }).then((result) => {
            if (result.isConfirmed && result.value) {
                const prefix = key === 'favA' ? 'è‡ªå®¶: ' : 'å…¬å¸: ';
                const newVal = prefix + result.value;
                const storageKey = key === 'favA' ? 'taxi_fav_A' : 'taxi_fav_B';
                
                localStorage.setItem(storageKey, newVal);
                document.getElementById(key).innerText = newVal;
            }
        });
    }

    function submitBooking() {
        const date = document.getElementById('dateData').value; // é€™è£¡ç¾åœ¨æœƒæ‹¿åˆ°å®Œæ•´çš„ YYYY-MM-DD
        const time = document.getElementById('timeData').value;
        const location = document.getElementById('locationData').value;
        const phone = document.getElementById('phoneData').value;

        if (!date || !time || !location) {
            Swal.fire({
                icon: 'warning',
                title: 'è³‡æ–™ä¸å®Œæ•´',
                text: 'è«‹ç¢ºèªæ—¥æœŸã€æ™‚é–“èˆ‡ä¸Šè»Šåœ°é»',
                confirmButtonColor: '#06c755'
            });
            return;
        }

        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = 'ç³»çµ±è™•ç†ä¸­...';

        liff.getProfile().then(profile => {
            const payload = {
                action: 'book',
                userId: profile.userId,
                displayName: profile.displayName,
                // === BUG FIX é‡é» ===
                // åŸæœ¬æ˜¯ date: date.substring(5) -> é€™æœƒåˆ‡æ‰å¹´ä»½ï¼Œå°è‡´å¾Œç«¯åˆ¤æ–·éŒ¯èª¤
                // ç¾åœ¨ç›´æ¥å‚³é€å®Œæ•´æ—¥æœŸ YYYY-MM-DD
                date: date, 
                // ==================
                time: time,
                location: location,
                phone: phone
            };

            // ä½¿ç”¨ no-cors æ¨¡å¼å‘¼å«å¯èƒ½æœƒæ‹¿ä¸åˆ°å›æ‡‰ JSONï¼Œ
            // ä½†æ¨™æº– GAS Web App åªè¦è¨­å®šæ­£ç¢ºé€šå¸¸å¯ä»¥è·¨åŸŸã€‚
            // é€™è£¡ç¶­æŒåŸæœ¬é‚è¼¯
            fetch(GAS_API_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
                // mode: 'no-cors' // å¦‚æœé‡åˆ° CORS éŒ¯èª¤å¯å˜—è©¦é–‹å•Ÿï¼Œä½†æœƒç„¡æ³•è®€å– response
            })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.innerText = 'ç¢ºèªé ç´„';

                if (data.status === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: 'é ç´„æˆåŠŸ',
                        text: 'å¸æ©Ÿå·²æ”¶åˆ°é€šçŸ¥ï¼',
                        confirmButtonColor: '#06c755'
                    }).then(() => {
                        liff.closeWindow();
                    });
                } else if (data.status === 'conflict') {
                    Swal.fire('æ™‚æ®µè¡çª', data.message, 'error');
                } else {
                    Swal.fire('éŒ¯èª¤', data.message || 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤', 'error');
                }
            })
            .catch(error => {
                console.error(error);
                btn.disabled = false;
                btn.innerText = 'ç¢ºèªé ç´„';
                
                // å¾ˆå¤šæ™‚å€™ GAS æˆåŠŸå¯«å…¥ä½†å›å‚³æ ¼å¼å°è‡´ fetch errorï¼Œé€™è£¡åšä¸€å€‹ä¿éšªæç¤º
                Swal.fire({
                    icon: 'error',
                    title: 'é€£ç·šç•°å¸¸',
                    text: 'è«‹æª¢æŸ¥ç¶²è·¯ã€‚è‹¥ç¢ºå®šå·²é€å‡ºï¼Œè«‹å‹¿é‡è¤‡é»æ“Šã€‚',
                    confirmButtonColor: '#d33'
                });
            });

        }).catch(err => {
            console.error(err);
            Swal.fire('LIFFéŒ¯èª¤', 'ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡æ–™ï¼Œè«‹åœ¨ LINE å…§é–‹å•Ÿ', 'error');
            btn.disabled = false;
        });
    }
</script>

</body>
</html>

