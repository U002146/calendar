<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>é ç´„æ´¾è»Š</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --primary: #06c755; --bg: #f5f5f5; --text: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: var(--bg); padding: 20px; color: var(--text); }
        
        /* å®¹å™¨ */
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* è¡¨å–®åˆ— */
        .row { margin-bottom: 20px; }
        .row-flex { display: flex; gap: 10px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 1.1rem; }
        
        /* è¼¸å…¥æ¡†å„ªåŒ– */
        input, select, button { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        input:focus { border-color: var(--primary); outline: none; }
        
        /* æ—¥æœŸæ™‚é–“ */
        .date-input { flex: 2; }
        .time-input { flex: 1; }

        /* åœ°é»åˆ— */
        .location-group { display: flex; gap: 8px; }
        .btn-map { background: #eee; color: #333; border: none; width: auto; white-space: nowrap; cursor: pointer; }
        
        /* è¯çµ¡é›»è©±æç¤º */
        .hint { font-size: 0.85rem; color: #888; margin-top: 4px; }

        /* é€å‡ºæŒ‰éˆ• */
        .btn-submit { background: var(--primary); color: white; font-size: 1.2rem; font-weight: bold; border: none; margin-top: 10px; cursor: pointer; }
        .btn-submit:disabled { background: #ccc; }

        /* æ¨¡æ…‹è¦–çª— (Modal) */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: flex-end; }
        .modal-content { background: white; width: 100%; border-radius: 20px 20px 0 0; padding: 20px; animation: slideUp 0.3s; max-height: 80vh; overflow-y: auto; }
        .tag-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .tag { padding: 8px 16px; background: #f0f0f0; border-radius: 20px; font-size: 0.95rem; cursor: pointer; border: 1px solid transparent; }
        .tag.saved { background: #e3f2fd; color: #0d47a1; border-color: #90caf9; }
        .tag:active { background: #ddd; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .close-btn { font-size: 1.5rem; background: none; border: none; width: auto; padding: 0; }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align: center; margin-top: 0;">é ç´„ç”¨è»Š</h2>
    
    <div class="row row-flex">
        <div class="date-input">
            <label>æ—¥æœŸ (æœˆ/æ—¥)</label>
            <input type="date" id="dateData">
        </div>
        <div class="time-input">
            <label>æ™‚é–“</label>
            <input type="time" id="timeData">
        </div>
    </div>

    <div class="row">
        <label>ä¸Šè»Šåœ°é»</label>
        <div class="location-group">
            <input type="text" id="locationData" placeholder="è«‹è¼¸å…¥æˆ–é¸æ“‡åœ°é»">
            <button type="button" class="btn-map" onclick="openLocationModal()">ğŸ“ é¸æ“‡</button>
        </div>
    </div>

    <div class="row">
        <label>è¯çµ¡é›»è©± <span style="font-size:0.9rem; font-weight:normal; color:#666;">(é¸å¡«)</span></label>
        <input type="tel" id="phoneData" placeholder="09xx...">
        <div class="hint">ğŸ’¡ æç¤ºï¼šæœ¬äººæ­è»Šå…å¡«ï¼Œå¹«è¦ªå‹å«è»Šè«‹å¡«å¯«å°æ–¹è™Ÿç¢¼ã€‚</div>
    </div>

    <button id="submitBtn" class="btn-submit" onclick="submitBooking()">ç¢ºèªé ç´„</button>
</div>

<div id="locationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>å¸¸ç”¨åœ°é»</h3>
            <button class="close-btn" onclick="closeLocationModal()">Ã—</button>
        </div>

        <p style="font-weight:bold; color:#666;">æˆ‘çš„æœ€æ„› (å¯ç·¨è¼¯)</p>
        <div class="tag-group">
            <div class="tag saved" id="favA" onclick="selectLocation(this.innerText)">è‡ªå®¶: èŠ±è“®å¸‚...</div>
            <button style="width:auto; padding:5px 10px; font-size:0.8rem;" onclick="editFavorite('favA')">âœï¸ ç·¨è¼¯A</button>
        </div>
        <div class="tag-group">
            <div class="tag saved" id="favB" onclick="selectLocation(this.innerText)">å…¬å¸: å‰å®‰é„‰...</div>
            <button style="width:auto; padding:5px 10px; font-size:0.8rem;" onclick="editFavorite('favB')">âœï¸ ç·¨è¼¯B</button>
        </div>

        <hr>
        <p style="font-weight:bold; color:#666;">èŠ±è“®ç†±é–€åœ°æ¨™</p>
        <div class="tag-group">
            <div class="tag" onclick="selectLocation('èŠ±è“®ç«è»Šç«™ (å‰ç«™)')">èŠ±è“®ç«è»Šç«™ (å‰ç«™)</div>
            <div class="tag" onclick="selectLocation('èŠ±è“®ç«è»Šç«™ (å¾Œç«™)')">èŠ±è“®ç«è»Šç«™ (å¾Œç«™)</div>
            <div class="tag" onclick="selectLocation('æ…ˆæ¿Ÿé†«é™¢ (å¤§é–€)')">æ…ˆæ¿Ÿé†«é™¢ (å¤§é–€)</div>
            <div class="tag" onclick="selectLocation('é–€è«¾é†«é™¢')">é–€è«¾é†«é™¢</div>
            <div class="tag" onclick="selectLocation('æ±å¤§é–€å¤œå¸‚')">æ±å¤§é–€å¤œå¸‚</div>
            <div class="tag" onclick="selectLocation('é é›„æ‚…ä¾†é£¯åº—')">é é›„æ‚…ä¾†é£¯åº—</div>
        </div>
    </div>
</div>

<script>
    // è¨­å®šå€
    const LIFF_ID = '2008907691-x4s1XueL'; 
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwODDCmwAggIyan3gxJJazGd3fWR9N2JsBk04OBQfyQ6SPjduhbQIEg_B_GZWH2Uex7/exec'; 

    // åˆå§‹åŒ–
    window.onload = function() {
        initLiff();
        loadFavorites(); // è®€å–å„²å­˜çš„åœ°å€
        setDefaultDate(); // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©
    };

    function initLiff() {
        liff.init({ liffId: LIFF_ID }).then(() => {
            if (!liff.isLoggedIn()) {
                liff.login();
            }
        }).catch(err => {
            console.error('LIFF Init Error', err);
        });
    }

    function setDefaultDate() {
        const now = new Date();
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        // æ—¥æœŸ input æ ¼å¼é€šå¸¸ç‚º YYYY-MM-DDï¼Œé€™è£¡ç‚ºäº†é¡¯ç¤ºæ–¹ä¾¿ä½¿ç”¨ç€è¦½å™¨é è¨­
        document.getElementById('dateData').valueAsDate = now;
    }

    // --- åœ°é»é¸æ“‡èˆ‡å„²å­˜é‚è¼¯ ---
    function openLocationModal() { document.getElementById('locationModal').style.display = 'flex'; }
    function closeLocationModal() { document.getElementById('locationModal').style.display = 'none'; }
    
    function selectLocation(text) {
        // å»é™¤æ¨™ç±¤ä¸­çš„ "è‡ªå®¶: " å‰ç¶´ï¼Œåªå¡«å…¥åœ°å€
        let address = text.includes(':') ? text.split(':')[1].trim() : text;
        document.getElementById('locationData').value = address;
        closeLocationModal();
    }

    function loadFavorites() {
        const a = localStorage.getItem('taxi_fav_A');
        const b = localStorage.getItem('taxi_fav_B');
        if (a) document.getElementById('favA').innerText = a;
        if (b) document.getElementById('favB').innerText = b;
    }

    function editFavorite(key) {
        const currentVal = document.getElementById(key).innerText;
        Swal.fire({
            title: 'ç·¨è¼¯å¸¸ç”¨åœ°å€',
            input: 'text',
            inputValue: currentVal,
            showCancelButton: true,
            confirmButtonText: 'å„²å­˜',
            cancelButtonText: 'å–æ¶ˆ'
        }).then((result) => {
            if (result.isConfirmed && result.value) {
                const storageKey = key === 'favA' ? 'taxi_fav_A' : 'taxi_fav_B';
                localStorage.setItem(storageKey, result.value);
                document.getElementById(key).innerText = result.value;
            }
        });
    }

    // --- é€å‡ºé ç´„æ ¸å¿ƒé‚è¼¯ ---
    function submitBooking() {
        const date = document.getElementById('dateData').value;
        const time = document.getElementById('timeData').value;
        const location = document.getElementById('locationData').value;
        const phone = document.getElementById('phoneData').value;

        // 1. åŸºæœ¬é©—è­‰
        if (!date || !time || !location) {
            Swal.fire('è³‡æ–™ä¸å®Œæ•´', 'è«‹å¡«å¯«æ—¥æœŸã€æ™‚é–“èˆ‡åœ°é»', 'warning');
            return;
        }

        // é–å®šæŒ‰éˆ•é¿å…é‡è¤‡é»æ“Š
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = 'ç³»çµ±æª¢æŸ¥ä¸­...';

        // 2. å–å¾—ä½¿ç”¨è€…å€‹è³‡
        liff.getProfile().then(profile => {
            const payload = {
                action: 'book',
                userId: profile.userId,
                displayName: profile.displayName,
                date: date.substring(5), // åªå– MM-DD
                time: time,
                location: location,
                phone: phone
            };

            // 3. ç™¼é€è‡³ GAS
            fetch(GAS_API_URL, {
                method: 'POST',
                body: JSON.stringify(payload),
                // "no-cors" æ¨¡å¼å¾ˆé‡è¦ï¼Œå› ç‚º GAS æœƒæœ‰ CORS é™åˆ¶ï¼Œ
                // ä½†ç‚ºäº†è®€å–å›æ‡‰ (æ’å–®æª¢æŸ¥)ï¼Œæˆ‘å€‘éœ€è¦ç”¨ä¸€äº›æŠ€å·§ã€‚
                // é€™è£¡æˆ‘å€‘ç›´æ¥ç”¨æ¨™æº–æ¨¡å¼ï¼Œè‹¥é‡åˆ° CORS éŒ¯èª¤ï¼Œå»ºè­°ä½¿ç”¨ redirect: 'follow'
            })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.innerText = 'ç¢ºèªé ç´„';

                if (data.status === 'success') {
                    Swal.fire('é ç´„æˆåŠŸ', 'å¸æ©Ÿå·²æ”¶åˆ°é€šçŸ¥ï¼', 'success').then(() => {
                        liff.closeWindow();
                    });
                } else if (data.status === 'conflict') {
                    Swal.fire('æ™‚æ®µè¡çª', data.message, 'error');
                } else {
                    Swal.fire('éŒ¯èª¤', data.message, 'error');
                }
            })
            .catch(error => {
                // GAS è‹¥å›  CORS æ‹‹éŒ¯ä½†å…¶å¯¦æˆåŠŸåŸ·è¡Œï¼Œé€™éƒ¨åˆ†æ¯”è¼ƒè¤‡é›œã€‚
                // åœ¨æ­¤æ¶æ§‹ä¸‹ï¼Œå»ºè­° GAS å›å‚³ JSONï¼Œå‰ç«¯è§£æã€‚
                // è‹¥é‡è·¨åŸŸå•é¡Œï¼Œæœ€ç©©è§£æ³•æ˜¯å°‡ HTML ç›´æ¥æ”¾åœ¨ GAS å…§ (ä½†æ‚¨è¦æ±‚ GitHub)ã€‚
                console.error(error);
                btn.disabled = false;
                btn.innerText = 'ç¢ºèªé ç´„';
                Swal.fire('é€£ç·šéŒ¯èª¤', 'è«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦', 'error');
            });

        }).catch(err => {
            console.error(err);
            Swal.fire('LIFFéŒ¯èª¤', 'ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡æ–™', 'error');
        });
    }
</script>

</body>
</html>
