<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¨ˆç¨‹è»Šè‡ªåŠ©é ç´„</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* é•·è¼©å‹å–„ç‰¹èª¿ */
    body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background-color: #f3f4f6; }
    .input-box { font-size: 1.2rem; padding: 15px; }
    .btn-large { font-size: 1.3rem; padding: 15px; font-weight: bold; }
    .addr-tag { cursor: pointer; border: 1px solid #cbd5e1; }
    .addr-tag.active { background-color: #dbeafe; border-color: #3b82f6; color: #1e40af; }
  </style>
</head>
<body class="p-4">

  <div id="profile-section" class="bg-white rounded-lg shadow p-4 mb-4 text-center hidden">
    <img id="user-picture" src="" alt="User" class="w-20 h-20 rounded-full mx-auto mb-2 border-4 border-yellow-400">
    <h2 class="text-xl font-bold text-gray-800">ä½ å¥½ï¼Œ<span id="user-name">ä¹˜å®¢</span>ï¼</h2>
    <p class="text-gray-500 text-sm">æ­¡è¿ä½¿ç”¨è‡ªåŠ©é ç´„æœå‹™</p>
  </div>

  <form id="booking-form" class="bg-white rounded-lg shadow p-4 space-y-6">
    
    <div>
      <label class="block text-gray-700 text-lg font-bold mb-2">ğŸ“… é ç´„æ™‚é–“</label>
      <input type="datetime-local" id="booking-time" class="input-box w-full border rounded bg-gray-50" required>
    </div>

    <div>
      <label class="block text-gray-700 text-lg font-bold mb-2">ğŸ“ ä¸Šè»Šåœ°é» <span class="text-red-500">*</span></label>
      
      <div class="grid grid-cols-3 gap-2 mb-3">
        <div onclick="fillAddress('A')" class="addr-tag rounded p-2 text-center text-lg">ğŸ  å®¶</div>
        <div onclick="fillAddress('B')" class="addr-tag rounded p-2 text-center text-lg">ğŸ¢ å…¬å¸</div>
        <div onclick="fillAddress('C')" class="addr-tag rounded p-2 text-center text-lg">ğŸ¥ é†«é™¢</div>
      </div>

      <div class="flex gap-2">
        <input type="text" id="location-input" placeholder="è«‹è¼¸å…¥åœ°å€æˆ–åœ°æ¨™" class="input-box w-full border rounded" required>
        <button type="button" onclick="saveCurrentAddress()" class="bg-gray-200 text-gray-700 px-4 rounded text-sm">
          è¨˜æ†¶<br>åœ°å€
        </button>
      </div>
      <p class="text-xs text-gray-400 mt-1">ğŸ’¡ é»é¸ä¸Šæ–¹æ¨™ç±¤å¯å¿«é€Ÿå¸¶å…¥ï¼Œè¼¸å…¥å¾ŒæŒ‰ã€Œè¨˜æ†¶ã€å¯æ›´æ–°æ¨™ç±¤å…§å®¹ã€‚</p>
    </div>

    <button type="submit" id="submit-btn" class="btn-large w-full bg-yellow-400 hover:bg-yellow-500 text-black rounded-lg shadow-md transition">
      ç¢ºèªé ç´„è¡Œç¨‹
    </button>
  </form>

  <div id="loading" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl text-center">
      <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-yellow-500 mx-auto mb-4"></div>
      <p class="text-lg font-bold">æ­£åœ¨æŸ¥è©¢å¸æ©Ÿè¡Œç¨‹...</p>
    </div>
  </div>

  <script>
    // --- é…ç½®å€ ---
    const LIFF_ID = '2008907691-x4s1XueL'; 
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwODDCmwAggIyan3gxJJazGd3fWR9N2JsBk04OBQfyQ6SPjduhbQIEg_B_GZWH2Uex7/exec';

    let userProfile = null;
    let currentTag = 'A'; // é è¨­æ“ä½œçš„è¨˜æ†¶æ¨™ç±¤

    // --- åˆå§‹åŒ– ---
    window.onload = async function() {
      await initializeLiff();
      loadSavedAddresses(); // å¾ localStorage è®€å–åœ°å€
      setDefaultTime();     // è¨­å®šé è¨­æ™‚é–“ç‚ºç¾åœ¨+30åˆ†
    };

    async function initializeLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (liff.isLoggedIn()) {
          userProfile = await liff.getProfile();
          document.getElementById('user-name').innerText = userProfile.displayName;
          document.getElementById('user-picture').src = userProfile.pictureUrl;
          document.getElementById('profile-section').classList.remove('hidden');
        } else {
          liff.login();
        }
      } catch (error) {
        console.error('LIFF Init Error', error);
        alert('LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ä½¿ç”¨ LINE é–‹å•Ÿ');
      }
    }

    // --- é‚è¼¯åŠŸèƒ½: åœ°å€è¨˜æ†¶ (Local Storage) ---
    // ç°¡å–®å¯¦ä½œï¼šåªå­˜å­—ä¸²ï¼Œä¸å­˜è¤‡é›œç‰©ä»¶
    function fillAddress(tag) {
      currentTag = tag;
      // è¦–è¦ºå›é¥‹
      document.querySelectorAll('.addr-tag').forEach(el => el.classList.remove('active'));
      event.target.classList.add('active');
      
      // è®€å–
      const saved = localStorage.getItem('taxi_addr_' + tag);
      if (saved) {
        document.getElementById('location-input').value = saved;
      } else {
        document.getElementById('location-input').placeholder = `å°šæœªè¨­å®š (è¼¸å…¥å¾ŒæŒ‰è¨˜æ†¶)`;
        document.getElementById('location-input').value = '';
      }
    }

    function saveCurrentAddress() {
      const val = document.getElementById('location-input').value;
      if (!val) return alert('è«‹å…ˆè¼¸å…¥åœ°å€ï¼');
      localStorage.setItem('taxi_addr_' + currentTag, val);
      alert(`å·²å°‡æ­¤åœ°å€è¨˜éŒ„åœ¨ã€Œé¸é … ${currentTag}ã€`);
    }

    function loadSavedAddresses() {
      // é è¨­å…ˆé¸ A
      fillAddress('A'); 
      // ä¹Ÿå¯ä»¥åœ¨é€™è£¡æ”¹è®ŠæŒ‰éˆ•æ–‡å­—ï¼Œå¦‚æœä¹‹å‰æœ‰å­˜éçš„è©± (é€²éšç‰ˆåŠŸèƒ½)
    }

    // --- é‚è¼¯åŠŸèƒ½: é è¨­æ™‚é–“ ---
    function setDefaultTime() {
      const now = new Date();
      now.setMinutes(now.getMinutes() + 30); // é è¨­ 30 åˆ†é˜å¾Œ
      // èª¿æ•´æ™‚å€ offset è½‰ ISO å­—ä¸²çµ¦ input ä½¿ç”¨
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      document.getElementById('booking-time').value = now.toISOString().slice(0,16);
    }

    // --- é€å‡ºè¡¨å–® ---
    document.getElementById('booking-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const dateTime = document.getElementById('booking-time').value;
      const location = document.getElementById('location-input').value;

      if(!userProfile) return alert('ç„¡æ³•è®€å–ä½¿ç”¨è€…è³‡è¨Š');

      // é¡¯ç¤º Loading
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('submit-btn').disabled = true;

      const payload = {
        userId: userProfile.userId,
        userName: userProfile.displayName,
        dateTime: dateTime,
        location: location
      };

      try {
        // ä½¿ç”¨ fetch é€åˆ° GAS
        // æ³¨æ„ï¼šGAS POST éœ€è¦è™•ç† CORSï¼Œæˆ–ä½¿ç”¨ no-cors (ä½†ç„¡æ³•è®€å–å›æ‡‰)
        // é€™è£¡å»ºè­°ä½¿ç”¨æ¨™æº– fetch + GAS è¼¸å‡º JSON æ¨™é ­
        const response = await fetch(GAS_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        
        const resData = await response.json();

        // éš±è— Loading
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('submit-btn').disabled = false;

        if (resData.status === 'success') {
          // æˆåŠŸæµç¨‹
          await liff.sendMessages([{
            type: 'text',
            text: `ã€é ç´„ç¢ºèªã€‘\næ™‚é–“ï¼š${dateTime.replace('T', ' ')}\nåœ°é»ï¼š${location}\nç‹€æ…‹ï¼šé ç´„æˆåŠŸ âœ…`
          }]);
          alert(resData.message);
          liff.closeWindow();
        } else {
          // å¤±æ•—æµç¨‹ (æ’æœŸ)
          alert(resData.message); // é¡¯ç¤º GAS å›å‚³çš„ "å¹¾é»å¹¾åˆ†å·²æœ‰é ç´„"
        }

      } catch (err) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('submit-btn').disabled = false;
        alert('ç³»çµ±é€£ç·šéŒ¯èª¤ï¼š' + err.message);
      }
    });
  </script>
</body>
</html>
