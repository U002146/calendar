<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>自助預約</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* AgeTech 視覺風格 */
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; padding: 20px; background: #f5f5f5; }
        .section { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h3 { margin: 0 0 10px 0; font-size: 18px; color: #333; }
        
        /* 1. 用戶資訊 */
        #user-info { display: flex; align-items: center; }
        #user-img { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; }
        #welcome-msg { font-size: 20px; font-weight: bold; }

        /* 2. 視覺化日期 (橫向捲動) */
        .date-scroller { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 5px; }
        .date-card { min-width: 80px; height: 80px; background: #eee; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; border: 2px solid transparent; }
        .date-card.active { border-color: #06c755; background: #e8fceb; color: #06c755; }
        .date-day { font-size: 14px; }
        .date-date { font-size: 24px; font-weight: bold; }

        /* 3. 大滾輪時間 (使用 Select 但極度放大) */
        select.big-select { width: 100%; font-size: 24px; padding: 15px; border-radius: 8px; border: 2px solid #ddd; background: #fff; -webkit-appearance: none; text-align: center; }

        /* 4. 地址輸入與記憶 */
        input[type="text"], input[type="tel"] { width: 100%; font-size: 18px; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; }
        .addr-tags { display: flex; gap: 10px; margin-top: 5px; }
        .addr-tag { padding: 8px 12px; background: #e0e0e0; border-radius: 20px; font-size: 16px; cursor: pointer; }
        .edit-mode .addr-tag { border: 2px dashed #ff9800; background: #fff8e1; }

        /* 按鈕 */
        #submit-btn { width: 100%; padding: 15px; background: #06c755; color: white; font-size: 22px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; }
        #submit-btn:disabled { background: #ccc; }
        .hint { font-size: 14px; color: #666; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div class="section" id="user-info">
        <img id="user-img" src="https://via.placeholder.com/50" alt="Avatar">
        <div id="welcome-msg">載入中...</div>
    </div>

    <div class="section">
        <h3>選擇日期</h3>
        <div class="date-scroller" id="date-container">
            </div>
    </div>

    <div class="section">
        <h3>預約時間 (24小時制)</h3>
        <select id="time-select" class="big-select">
            </select>
    </div>

    <div class="section">
        <div style="display:flex; justify-content:space-between;">
            <h3>上車地點</h3>
            <span style="font-size:14px; color:#007bff; cursor:pointer;" onclick="toggleEditAddr()">⚙️ 設定常用</span>
        </div>
        <input type="text" id="location" placeholder="請輸入地點或地標">
        <div class="addr-tags" id="addr-tags">
            </div>
    </div>

    <div class="section">
        <h3>聯絡電話 <span style="font-size:14px; font-weight:normal; color:red;">(選填)</span></h3>
        <p class="hint">如果是「幫家人叫車」，請填寫乘客電話</p>
        <input type="tel" id="phone" placeholder="留空則預設為本人">
    </div>

    <button id="submit-btn" onclick="submitBooking()">確認預約</button>

    <script>
        // 設定區
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwODDCmwAggIyan3gxJJazGd3fWR9N2JsBk04OBQfyQ6SPjduhbQIEg_B_GZWH2Uex7/exec';
        let userProfile = null;
        let selectedDate = null;
        let isEditAddrMode = false;

        // 初始化 LIFF
        async function main() {
            await liff.init({ liffId: "2008907691-x4s1XueL" });
            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }
            userProfile = await liff.getProfile();
            document.getElementById('user-img').src = userProfile.pictureUrl;
            document.getElementById('welcome-msg').innerText = `你好，${userProfile.displayName}`;
            
            initDates();
            initTimeSelect();
            renderAddrTags();
        }
        main();

        // 1. 初始化日期 (今天 + 未來 13 天)
        function initDates() {
            const container = document.getElementById('date-container');
            const today = new Date();
            const weekDays = ['日', '一', '二', '三', '四', '五', '六'];
            
            for (let i = 0; i < 14; i++) {
                let d = new Date();
                d.setDate(today.getDate() + i);
                let dayStr = (i === 0) ? '今天' : `週${weekDays[d.getDay()]}`;
                let dateStr = `${d.getMonth()+1}/${d.getDate()}`;
                let fullDate = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;

                let card = document.createElement('div');
                card.className = 'date-card';
                if (i === 0) { card.classList.add('active'); selectedDate = fullDate; }
                card.innerHTML = `<span class="date-day">${dayStr}</span><span class="date-date">${dateStr}</span>`;
                
                card.onclick = () => {
                    document.querySelectorAll('.date-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    selectedDate = fullDate;
                };
                container.appendChild(card);
            }
        }

        // 2. 初始化時間 (每 30 分鐘一格)
        function initTimeSelect() {
            const select = document.getElementById('time-select');
            for (let h = 0; h < 24; h++) {
                for (let m = 0; m < 60; m += 30) {
                    let time = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                    let opt = document.createElement('option');
                    opt.value = time;
                    opt.text = time;
                    // 預設選中下一小時
                    if (h === new Date().getHours() + 1 && m === 0) opt.selected = true;
                    select.appendChild(opt);
                }
            }
        }

        // 3. 地址記憶功能
        function getSavedAddrs() {
            return JSON.parse(localStorage.getItem('my_taxi_addrs')) || ['花蓮火車站', '慈濟醫院', '自家'];
        }

        function renderAddrTags() {
            const tagsDiv = document.getElementById('addr-tags');
            tagsDiv.innerHTML = '';
            const addrs = getSavedAddrs();
            
            addrs.forEach((addr, index) => {
                let tag = document.createElement('div');
                tag.className = 'addr-tag';
                tag.innerText = addr;
                tag.onclick = () => {
                    if (isEditAddrMode) {
                        let newAddr = prompt("修改常用地址:", addr);
                        if (newAddr) {
                            addrs[index] = newAddr;
                            localStorage.setItem('my_taxi_addrs', JSON.stringify(addrs));
                            renderAddrTags();
                        }
                    } else {
                        document.getElementById('location').value = addr;
                    }
                };
                tagsDiv.appendChild(tag);
            });
        }

        function toggleEditAddr() {
            isEditAddrMode = !isEditAddrMode;
            document.body.classList.toggle('edit-mode');
            renderAddrTags();
        }

        // 4. 送出預約
        function submitBooking() {
            const time = document.getElementById('time-select').value;
            const location = document.getElementById('location').value;
            const phone = document.getElementById('phone').value;

            if (!location) { alert('請輸入上車地點'); return; }

            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.innerText = '預約處理中...';

            const payload = {
                type: 'booking',
                userId: userProfile.userId,
                userDisplayName: userProfile.displayName,
                date: selectedDate,
                time: time,
                location: location,
                phone: phone,
                notes: ''
            };

            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify(payload) // 使用 no-cors 時無法讀取回傳，若需讀取回傳需用標準 CORS 或 GAS 回傳 redirect
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('預約成功！請查看聊天室通知。');
                    liff.closeWindow();
                } else {
                    alert(data.message);
                    btn.disabled = false;
                    btn.innerText = '確認預約';
                }
            })
            .catch(err => {
                // GAS 若無設定 CORS header，跨域可能會報錯但實際執行成功
                // 建議在 GAS 端做好 ContentService 回傳 header
                console.error(err);
                alert('連線錯誤或預約成功 (若收到LINE通知即為成功)');
                liff.closeWindow();
            });
        }
    </script>
</body>
</html>
