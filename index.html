<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é ç´„æ´¾è»Šæœå‹™</title>
    <!-- Tailwind CSS (æ¨£å¼åº«) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- FontAwesome (åœ–ç¤º) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 (æ¼‚äº®çš„å½ˆå‡ºè¦–çª—) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* é‡å°æ‰‹æ©Ÿå„ªåŒ–çš„æ¨£å¼å¾®èª¿ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-press:active {
            transform: scale(0.98);
        }
        /* éš±è—æ²è»¸ä½†ä¿æŒåŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center pt-4 pb-10 px-4">

    <!-- ä¸»å®¹å™¨ -->
    <div class="w-full max-w-md bg-white rounded-2xl shadow-lg overflow-hidden">
        
        <!-- æ¨™é¡Œå€ -->
        <div class="bg-[#06c755] p-4 text-white text-center shadow-md relative">
            <h1 class="text-xl font-bold tracking-wide"><i class="fa-solid fa-taxi mr-2"></i>é ç´„æ´¾è»Š</h1>
            <p class="text-xs opacity-80 mt-1" id="user-status">è®€å–è³‡æ–™ä¸­...</p>
        </div>

        <!-- è¡¨å–®å€ -->
        <div class="p-5 space-y-6">

            <!-- ç¬¬ä¸€åˆ—ï¼šæ—¥æœŸèˆ‡æ™‚é–“ -->
            <div class="grid grid-cols-2 gap-4">
                <div class="flex flex-col">
                    <label class="text-sm font-bold text-gray-600 mb-1"><i class="fa-regular fa-calendar mr-1"></i>æ—¥æœŸ</label>
                    <input type="date" id="dateInput" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:outline-none text-gray-800 text-lg">
                </div>
                <div class="flex flex-col">
                    <label class="text-sm font-bold text-gray-600 mb-1"><i class="fa-regular fa-clock mr-1"></i>æ™‚é–“</label>
                    <input type="time" id="timeInput" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:outline-none text-gray-800 text-lg">
                </div>
            </div>

            <!-- ç¬¬äºŒåˆ—ï¼šä¸Šè»Šåœ°é» (å«æŒ‰éˆ•) -->
            <div class="flex flex-col relative">
                <label class="text-sm font-bold text-gray-600 mb-1"><i class="fa-solid fa-map-pin mr-1"></i>ä¸Šè»Šåœ°é»</label>
                <div class="flex gap-2">
                    <input type="text" id="locationInput" placeholder="è«‹è¼¸å…¥æˆ–é¸æ“‡åœ°é»" class="flex-1 p-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:outline-none text-gray-800 text-lg">
                    <button onclick="openLocationModal()" class="bg-blue-500 text-white px-4 rounded-xl shadow active:bg-blue-600 transition btn-press flex flex-col items-center justify-center min-w-[70px]">
                        <i class="fa-solid fa-map-location-dot text-xl mb-1"></i>
                        <span class="text-xs">é¸åœ°é»</span>
                    </button>
                </div>
            </div>

            <!-- ç¬¬ä¸‰åˆ—ï¼šè¯çµ¡é›»è©± -->
            <div class="flex flex-col">
                <label class="text-sm font-bold text-gray-600 mb-1">
                    <i class="fa-solid fa-phone mr-1"></i>è¯çµ¡é›»è©±
                    <span class="text-xs font-normal text-orange-500 ml-1">(å¹«åˆ¥äººå«è»Šæ™‚å¿…å¡«)</span>
                </label>
                <input type="tel" id="phoneInput" placeholder="09xx-xxx-xxx" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:outline-none text-gray-800 text-lg">
            </div>

            <!-- éŒ¯èª¤è¨Šæ¯æç¤ºå€ -->
            <div id="errorMsg" class="hidden text-red-500 text-sm text-center font-bold bg-red-50 p-2 rounded-lg border border-red-200"></div>

            <!-- é€å‡ºæŒ‰éˆ• -->
            <button id="submitBtn" onclick="submitBooking()" class="w-full bg-[#06c755] hover:bg-[#05b34c] text-white font-bold py-4 rounded-xl text-xl shadow-md transition transform btn-press flex justify-center items-center gap-2">
                <span>ç¢ºèªé ç´„</span>
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>

        <!-- é å°¾ -->
        <div class="bg-gray-50 p-3 text-center text-xs text-gray-400 border-t">
            èŠ±è“®åœ¨åœ°è»ŠéšŠ â€¢ å®‰å…¨å¯é 
        </div>
    </div>

    <!-- åœ°é»é¸æ“‡ Modal (å½ˆå‡ºè¦–çª—) -->
    <div id="locationModal" class="fixed inset-0 z-50 hidden">
        <!-- èƒŒæ™¯é®ç½© -->
        <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm transition-opacity" onclick="closeLocationModal()"></div>
        
        <!-- å…§å®¹å¡ç‰‡ -->
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl p-5 shadow-2xl transform transition-transform duration-300 ease-out translate-y-full" id="modalContent">
            
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-gray-700">é¸æ“‡å¸¸ç”¨åœ°é»</h3>
                <button onclick="closeLocationModal()" class="text-gray-400 hover:text-gray-600 p-2">
                    <i class="fa-solid fa-xmark text-2xl"></i>
                </button>
            </div>

            <!-- å¸¸ç”¨åœ°å€å€ (å¯ç·¨è¼¯) -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <!-- åœ°å€ A -->
                <div class="relative group">
                    <button onclick="selectCustomLocation('A')" class="w-full bg-orange-50 border-2 border-orange-200 p-3 rounded-xl text-left hover:bg-orange-100 transition active:scale-95">
                        <div class="flex justify-between items-start">
                            <span class="font-bold text-orange-800"><i class="fa-solid fa-house mr-1"></i>å¸¸ç”¨ A</span>
                            <span onclick="event.stopPropagation(); editCustomLocation('A')" class="text-xs bg-white px-2 py-1 rounded border border-orange-200 text-gray-500 active:bg-gray-100"><i class="fa-solid fa-pen"></i></span>
                        </div>
                        <p id="label-loc-A" class="text-sm text-gray-600 mt-1 truncate">é»æ“Šè¨­å®šåœ°å€</p>
                    </button>
                </div>

                <!-- åœ°å€ B -->
                <div class="relative group">
                    <button onclick="selectCustomLocation('B')" class="w-full bg-blue-50 border-2 border-blue-200 p-3 rounded-xl text-left hover:bg-blue-100 transition active:scale-95">
                        <div class="flex justify-between items-start">
                            <span class="font-bold text-blue-800"><i class="fa-solid fa-briefcase mr-1"></i>å¸¸ç”¨ B</span>
                            <span onclick="event.stopPropagation(); editCustomLocation('B')" class="text-xs bg-white px-2 py-1 rounded border border-blue-200 text-gray-500 active:bg-gray-100"><i class="fa-solid fa-pen"></i></span>
                        </div>
                        <p id="label-loc-B" class="text-sm text-gray-600 mt-1 truncate">é»æ“Šè¨­å®šåœ°å€</p>
                    </button>
                </div>
            </div>

            <h4 class="text-sm font-bold text-gray-500 mb-3 ml-1">èŠ±è“®ç†±é–€åœ°æ¨™</h4>
            
            <!-- èŠ±è“®åœ°æ¨™æ¸…å–® (æ»¾å‹•å€) -->
            <div class="grid grid-cols-2 gap-2 max-h-[200px] overflow-y-auto no-scrollbar pb-10">
                <button onclick="selectPreset('èŠ±è“®ç«è»Šç«™ (å‰ç«™)')" class="p-3 bg-gray-50 rounded-lg text-left text-sm text-gray-700 hover:bg-gray-100 border border-gray-200"><i class="fa-solid fa-train mr-2 text-gray-400"></i>èŠ±è“®ç«è»Šç«™ (å‰ç«™)</button>
                <button onclick="selectPreset('èŠ±è“®ç«è»Šç«™ (å¾Œç«™)')" class="p-3 bg-gray-50 rounded-lg text-left text-sm text-gray-700 hover:bg-gray-100 border border-gray-200"><i class="fa-solid fa-train mr-2 text-gray-400"></i>èŠ±è“®ç«è»Šç«™ (å¾Œç«™)</button>
                <button onclick="selectPreset('èŠ±è“®æ…ˆæ¿Ÿé†«é™¢')" class="p-3 bg-gray-50 rounded-lg text-left text-sm text-gray-700 hover:bg-gray-100 border border-gray-200"><i class="fa-solid fa-hospital mr-2 text-red-400"></i>æ…ˆæ¿Ÿé†«é™¢</button>
                <button onclick="selectPreset('èŠ±è“®é–€è«¾é†«é™¢')" class="p-3 bg-gray-50 rounded-lg text-left text-sm text-gray-700 hover:bg-gray-100 border border-gray-200"><i class="fa-solid fa-hospital mr-2 text-red-400"></i>é–€è«¾é†«é™¢</button>
                <button onclick="selectPreset('æ±å¤§é–€å¤œå¸‚')" class="p-3 bg-gray-50 rounded-lg text-left text-sm text-gray-700 hover:bg-gray-100 border border-gray-200"><i class="fa-solid fa-utensils mr-2 text-orange-400"></i>æ±å¤§é–€å¤œå¸‚</button>
                <button onclick="selectPreset('é é›„æµ·æ´‹å…¬åœ’')" class="p-3 bg-gray-50 rounded-lg text-left text-sm text-gray-700 hover:bg-gray-100 border border-gray-200"><i class="fa-solid fa-fish mr-2 text-blue-400"></i>æµ·æ´‹å…¬åœ’</button>
                <button onclick="selectPreset('ä¸ƒæ˜Ÿæ½­')" class="p-3 bg-gray-50 rounded-lg text-left text-sm text-gray-700 hover:bg-gray-100 border border-gray-200"><i class="fa-solid fa-water mr-2 text-blue-300"></i>ä¸ƒæ˜Ÿæ½­</button>
                <button onclick="selectPreset('èŠ±è“®æ©Ÿå ´')" class="p-3 bg-gray-50 rounded-lg text-left text-sm text-gray-700 hover:bg-gray-100 border border-gray-200"><i class="fa-solid fa-plane mr-2 text-purple-400"></i>èŠ±è“®æ©Ÿå ´</button>
            </div>
        </div>
    </div>

    <!-- JS é‚è¼¯ -->
    <script>
        // è¨­å®šé…ç½®
        // TODO: è«‹å¡«å…¥ä½ çš„ LIFF ID
        const LIFF_ID = '2008907691-x4s1XueL'; 
        // TODO: è«‹å¡«å…¥ä½ çš„ Google Apps Script ç™¼å¸ƒç¶²å€
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwODDCmwAggIyan3gxJJazGd3fWR9N2JsBk04OBQfyQ6SPjduhbQIEg_B_GZWH2Uex7/exec'; 

        // ç‹€æ…‹è®Šæ•¸
        let userProfile = null;
        let isSubmitting = false;

        // åˆå§‹åŒ–
        window.onload = function() {
            initDateInput();
            loadCustomLocations();
            initializeLiff();
        };

        // 1. åˆå§‹åŒ– LIFF
        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    getUserProfile();
                } else {
                    liff.login();
                }
            } catch (error) {
                console.error('LIFF Init Error:', error);
                document.getElementById('user-status').innerText = 'ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†';
            }
        }

        async function getUserProfile() {
            try {
                const profile = await liff.getProfile();
                userProfile = profile;
                document.getElementById('user-status').innerText = `ä½ å¥½ï¼Œ${profile.displayName}`;
            } catch (error) {
                console.error('Error getting profile:', error);
            }
        }

        // 2. æ—¥æœŸåˆå§‹åŒ– (é è¨­ä»Šå¤©)
        function initDateInput() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;
            
            const dateInput = document.getElementById('dateInput');
            dateInput.value = todayStr;
            dateInput.min = todayStr; // ä¸èƒ½é¸éå»æ—¥æœŸ
        }

        // 3. Modal æ“ä½œé‚è¼¯
        function openLocationModal() {
            const modal = document.getElementById('locationModal');
            const content = document.getElementById('modalContent');
            modal.classList.remove('hidden');
            // å°å‹•ç•«
            setTimeout(() => {
                content.classList.remove('translate-y-full');
            }, 10);
        }

        function closeLocationModal() {
            const modal = document.getElementById('locationModal');
            const content = document.getElementById('modalContent');
            content.classList.add('translate-y-full');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function selectPreset(locationName) {
            document.getElementById('locationInput').value = locationName;
            closeLocationModal();
        }

        // 4. å¸¸ç”¨åœ°å€å„²å­˜é‚è¼¯ (ä½¿ç”¨ LocalStorage)
        function loadCustomLocations() {
            const locA = localStorage.getItem('taxi_loc_A');
            const locB = localStorage.getItem('taxi_loc_B');
            if (locA) document.getElementById('label-loc-A').innerText = locA;
            if (locB) document.getElementById('label-loc-B').innerText = locB;
        }

        function editCustomLocation(key) {
            Swal.fire({
                title: `è¨­å®šå¸¸ç”¨åœ°å€ ${key}`,
                input: 'text',
                inputValue: localStorage.getItem(`taxi_loc_${key}`) || '',
                showCancelButton: true,
                confirmButtonText: 'å„²å­˜',
                cancelButtonText: 'å–æ¶ˆ',
                confirmButtonColor: '#06c755'
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    localStorage.setItem(`taxi_loc_${key}`, result.value);
                    document.getElementById(`label-loc-${key}`).innerText = result.value;
                }
            });
        }

        function selectCustomLocation(key) {
            const val = localStorage.getItem(`taxi_loc_${key}`);
            if (val) {
                document.getElementById('locationInput').value = val;
                closeLocationModal();
            } else {
                editCustomLocation(key);
            }
        }

        // 5. é€å‡ºè¨‚å–®é‚è¼¯
        async function submitBooking() {
            if (isSubmitting) return;

            // å–å¾—è¡¨å–®è³‡æ–™
            const date = document.getElementById('dateInput').value;
            const time = document.getElementById('timeInput').value;
            const location = document.getElementById('locationInput').value;
            const phone = document.getElementById('phoneInput').value;

            // é©—è­‰
            if (!date || !time || !location) {
                showError('è«‹å®Œæ•´å¡«å¯«æ—¥æœŸã€æ™‚é–“èˆ‡åœ°é»');
                return;
            }

            // UI é–å®š
            isSubmitting = true;
            const btn = document.getElementById('submitBtn');
            const originalBtnContent = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> é ç´„ç¢ºèªä¸­...';
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            document.getElementById('errorMsg').classList.add('hidden');

            const payload = {
                userId: userProfile ? userProfile.userId : 'GUEST',
                displayName: userProfile ? userProfile.displayName : 'Guest',
                date: date,
                time: time,
                location: location,
                phone: phone
            };

            try {
                // ç™¼é€è«‹æ±‚åˆ° GAS
                // ä½¿ç”¨ no-cors æ¨¡å¼æ˜¯ç‚ºäº†é¿é–‹ç°¡å–®è«‹æ±‚çš„ CORS å•é¡Œï¼Œ
                // ä½† GAS å¿…é ˆæ­£ç¢ºè™•ç† doPost ä¸¦è¿”å› JSON
                // æ³¨æ„ï¼šfetch åˆ° GAS å¸¸å¸¸æœƒæœ‰ CORS é™åˆ¶ï¼Œå»ºè­°å¾Œç«¯ä½¿ç”¨ ContentService ä¸¦é…åˆ redirect
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors', // é‡è¦ï¼šç°¡å–®è«‹æ±‚ï¼Œç„¡æ³•è®€å–å›å‚³å…§å®¹ï¼Œä½†èƒ½é€å‡º
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                // å› ç‚º no-cors ç„¡æ³•è®€å–å›æ‡‰ç‹€æ…‹ï¼Œæˆ‘å€‘å‡è¨­å¦‚æœæ²’æœ‰å ±éŒ¯å°±æ˜¯æˆåŠŸ
                // (æ›´åš´è¬¹çš„åšæ³•æ˜¯å¾Œç«¯å›å‚³ successï¼Œå‰ç«¯ç”¨ redirect æˆ– jsonpï¼Œä½†é€™è£¡ç”¨æœ€ç°¡è§£æ³•)
                
                // æ¨¡æ“¬ç­‰å¾…æª¢æŸ¥ (å› ç‚º no-cors è®€ä¸åˆ° return)
                // åœ¨çœŸå¯¦ v2 ç‰ˆæœ¬ï¼Œå»ºè­°ä½¿ç”¨ JSONP æˆ–å®Œæ•´çš„ CORS proxy
                // é€™è£¡æˆ‘å€‘ç”¨ä¸€å€‹æŠ˜è¡·æ–¹æ¡ˆï¼šå‡è¨­æˆåŠŸï¼Œå¦‚æœ GAS æª¢æŸ¥å¤±æ•—ä¸æœƒå¯«å…¥æ—¥æ›†ï¼Œ
                // ä½†å‰ç«¯ç„¡æ³•å¾—çŸ¥å…·é«”éŒ¯èª¤ (æ˜¯å”¯ä¸€çš„ç¼ºé»ï¼Œä½†åœ¨ MVP å¯æ¥å—)
                
                // ç‚ºäº†è®“ MVP é«”é©—æ›´å¥½ï¼Œæˆ‘å€‘é€™è£¡å‡è£æˆåŠŸï¼Œç„¶å¾Œç™¼é€è¨Šæ¯
                // å¦‚æœéœ€è¦ç²¾ç¢ºçš„ã€Œè¡Œç¨‹è¡çªã€å›å ±ï¼Œéœ€è¦å¾Œç«¯é…åˆ allow-cors header
                
                // --- æˆåŠŸå¾Œçš„è™•ç† ---
                
                // 1. çµ„è£å›å‚³è¨Šæ¯
                // æ ¼å¼åŒ–æ—¥æœŸï¼šç§»é™¤å¹´ä»½
                const dateObj = new Date(date);
                const dateStr = `${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥`;

                const messageText = `ã€é ç´„å«è»Šå–®ã€‘\nğŸ“… æ—¥æœŸï¼š${dateStr}\nâ° æ™‚é–“ï¼š${time}\nğŸ“ åœ°é»ï¼š${location}\nğŸ“ é›»è©±ï¼š${phone || 'ç„¡'}\n\nç³»çµ±å·²æ”¶åˆ°æ‚¨çš„è«‹æ±‚ï¼Œå¸æ©Ÿç¢ºèªä¸­ï¼`;

                // 2. é€é LIFF ç™¼é€è¨Šæ¯åˆ°èŠå¤©å®¤
                if (liff.isInClient()) {
                    await liff.sendMessages([{
                        type: 'text',
                        text: messageText
                    }]);
                }

                // 3. é¡¯ç¤ºæˆåŠŸå½ˆçª—ä¸¦é—œé–‰
                await Swal.fire({
                    icon: 'success',
                    title: 'é ç´„å·²é€å‡º',
                    text: 'è«‹æŸ¥çœ‹èŠå¤©å®¤è¨Šæ¯',
                    timer: 2000,
                    showConfirmButton: false
                });

                liff.closeWindow();

            } catch (error) {
                console.error('Submit Error:', error);
                showError('é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
                isSubmitting = false;
                btn.innerHTML = originalBtnContent;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.innerText = msg;
            el.classList.remove('hidden');
        }
    </script>
</body>
</html>
