<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‡ªåŠ©é ç´„ï¼šæˆ‘çš„è¡Œç¨‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/locale/zh-tw.min.js"></script>
    <style>
        /* å¼·åˆ¶é˜²æ­¢ iOS ç¸®æ”¾ï¼Œä¸¦è¨­å®šåŸºç¤å­—é«”å¤§å° */
        input, select, textarea { font-size: 17px !important; } 
        .hidden { display: none !important; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .slot-btn.disabled {
            background-color: #f3f4f6;
            color: #d1d5db;
            border-color: #e5e7eb;
            cursor: not-allowed;
            text-decoration: line-through;
        }
        .slot-btn.selected {
            background-color: #3b82f6;
            color: white;
            border-color: #2563eb;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="loader mb-4 w-12 h-12 border-4 text-blue-500"></div>
        <p id="loading-text" class="text-gray-500 font-bold text-lg">æ­£åœ¨è®€å–é ç´„è¡¨...</p>
    </div>

    <div id="app" class="hidden min-h-screen flex justify-center p-0 md:p-4">
        <div class="w-full max-w-md bg-white shadow-2xl rounded-none md:rounded-3xl overflow-hidden min-h-screen md:min-h-0 flex flex-col">
            
            <!-- Header -->
            <header class="bg-gradient-to-r from-blue-600 to-blue-500 text-white p-6 pb-8 rounded-b-[2.5rem] shadow-lg z-10 relative">
                <div class="text-center">
                    <h1 class="text-2xl font-extrabold tracking-wide">ğŸ—“ï¸ è‡ªåŠ©é ç´„æˆ‘çš„è¡Œç¨‹</h1>
                    <p id="user-display" class="text-blue-100 text-sm mt-2 font-medium">è¼‰å…¥ä½¿ç”¨è€…...</p>
                </div>
            </header>

            <!-- Form Container -->
            <div class="flex-1 overflow-y-auto p-4 -mt-4 relative z-20 space-y-6 pb-24">
                
                <!-- 1. æ—¥æœŸé¸æ“‡ (æ©«å‘æ²è»¸) -->
                <div class="bg-white p-4 rounded-3xl shadow-sm border border-gray-100">
                    <label class="block font-bold text-gray-700 mb-3 text-lg flex items-center">
                        ğŸ“… é¸æ“‡æ—¥æœŸ
                    </label>
                    <div id="date-scroller" class="flex space-x-3 overflow-x-auto hide-scrollbar pb-2">
                        <!-- JS å‹•æ…‹ç”Ÿæˆæ—¥æœŸæŒ‰éˆ• -->
                    </div>
                </div>

                <!-- 2. æ™‚æ®µé¸æ“‡ (ç¶²æ ¼) -->
                <div class="bg-white p-4 rounded-3xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-end mb-3">
                        <label class="font-bold text-gray-700 text-lg">ğŸ•’ é¸æ“‡æ™‚æ®µ</label>
                        <span class="text-xs text-gray-400">æ¯æ¬¡é ç´„ 30 åˆ†é˜</span>
                    </div>
                    
                    <div id="time-grid" class="grid grid-cols-4 gap-2">
                        <div class="col-span-4 text-center text-gray-400 py-4 text-sm">è«‹å…ˆé¸æ“‡ä¸Šæ–¹æ—¥æœŸ</div>
                    </div>
                    
                    <div class="mt-3 flex justify-center space-x-4 text-xs text-gray-500">
                        <div class="flex items-center"><div class="w-3 h-3 bg-white border border-blue-500 rounded mr-1"></div>å¯é ç´„</div>
                        <div class="flex items-center"><div class="w-3 h-3 bg-blue-500 rounded mr-1"></div>å·²é¸</div>
                        <div class="flex items-center"><div class="w-3 h-3 bg-gray-100 border border-gray-200 rounded mr-1 decoration-slice"></div>å·²æ»¿</div>
                    </div>
                </div>

                <!-- 3. åŸºæœ¬è³‡æ–™è¡¨å–® -->
                <form id="booking-form" class="bg-white rounded-3xl shadow-md border border-gray-100 p-5 space-y-4">
                    <input type="hidden" id="name">
                    <input type="hidden" id="selected-date">
                    <input type="hidden" id="selected-time">

                    <!-- è¯çµ¡é›»è©± -->
                    <div>
                        <label class="block font-bold text-gray-700 mb-2">ğŸ“ è¯çµ¡é›»è©±</label>
                        <input type="tel" id="phone" required placeholder="09xx-xxx-xxx" inputmode="numeric" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all text-lg font-bold tracking-wider text-gray-700">
                    </div>

                    <!-- ä¸Šè»Šåœ°é» -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block font-bold text-green-600">ğŸŸ¢ ä¸Šè»Šåœ°é»</label>
                            <button type="button" onclick="openLocationPicker('pickup')" class="px-3 py-1 bg-green-50 text-green-700 text-xs font-bold rounded-full border border-green-200">ğŸ“ é¸åœ°é»</button>
                        </div>
                        <input type="text" id="pickup" required placeholder="è¼¸å…¥ä¸Šè»Šè™•" class="w-full p-3 border border-gray-200 rounded-xl text-base shadow-sm focus:ring-2 focus:ring-green-500 outline-none">
                    </div>

                    <!-- ä¸‹è»Šåœ°é» -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block font-bold text-red-600">ğŸ”´ ä¸‹è»Šåœ°é»</label>
                            <button type="button" onclick="openLocationPicker('dropoff')" class="px-3 py-1 bg-red-50 text-red-700 text-xs font-bold rounded-full border border-red-200">ğŸ“ é¸åœ°é»</button>
                        </div>
                        <input type="text" id="dropoff" required placeholder="è¼¸å…¥ç›®çš„åœ°" class="w-full p-3 border border-gray-200 rounded-xl text-base shadow-sm focus:ring-2 focus:ring-red-500 outline-none">
                    </div>

                    <!-- ä»˜æ¬¾æ–¹å¼ -->
                    <div>
                         <label class="block font-bold text-gray-700 mb-2">ğŸ’° ä»˜æ¬¾æ–¹å¼</label>
                         <select id="payment" class="w-full p-3 bg-yellow-50 border border-yellow-200 rounded-xl text-base font-medium text-gray-800 outline-none">
                            <option value="ç¾é‡‘">ğŸ’µ ç¾é‡‘</option>
                            <option value="æ•¬è€å¡">ğŸ§“ æ•¬è€å¡</option>
                            <option value="æ„›å¿ƒå¡">â¤ï¸ æ„›å¿ƒå¡</option>
                            <option value="LINE PAY">ğŸ’³ LINE PAY</option>
                        </select>
                    </div>
                </form>
            </div>

            <!-- Footer Action -->
            <div class="p-4 bg-white border-t border-gray-100 z-30 fixed bottom-0 w-full max-w-md md:static md:rounded-b-3xl">
                <button id="submitBtn" onclick="confirmAndSubmit()" disabled class="w-full py-3 rounded-2xl bg-gray-300 text-white text-lg font-bold shadow-sm transition-all flex justify-center items-center">
                    è«‹å…ˆé¸æ“‡æ™‚é–“
                </button>
            </div>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // è¨­å®šä¸­æ–‡èªç³»
        dayjs.locale('zh-tw');
        
        // â˜…â˜…â˜… ä½ çš„ GAS API URL (æœªä¾†å¡«é€™è£¡) â˜…â˜…â˜…
        // ç›®å‰å…ˆç”¨æ¨¡æ“¬è³‡æ–™
        const GOOGLE_CALENDAR_API_URL = ""; 

        const dom = {
            loading: document.getElementById('loading-overlay'),
            app: document.getElementById('app'),
            userDisplay: document.getElementById('user-display'),
            btn: document.getElementById('submitBtn'),
            dateScroller: document.getElementById('date-scroller'),
            timeGrid: document.getElementById('time-grid'),
            inputs: {
                name: document.getElementById('name'),
                phone: document.getElementById('phone'),
                pickup: document.getElementById('pickup'),
                dropoff: document.getElementById('dropoff'),
                payment: document.getElementById('payment'),
                selectedDate: document.getElementById('selected-date'),
                selectedTime: document.getElementById('selected-time')
            }
        };

        // æ¨¡æ“¬å·²é ç´„çš„æ™‚æ®µ (é€™éƒ¨åˆ†æœªä¾†ç”± GAS å›å‚³)
        // æ ¼å¼ï¼šYYYY-MM-DD HH:mm
        const MOCK_BUSY_SLOTS = [
            dayjs().add(1, 'day').format('YYYY-MM-DD') + ' 10:00',
            dayjs().add(1, 'day').format('YYYY-MM-DD') + ' 14:30',
            dayjs().format('YYYY-MM-DD') + ' 12:00' // ä»Šå¤©ä¸­åˆæ»¿äº†
        ];

        // ç‡Ÿæ¥­æ™‚é–“è¨­å®š
        const BUSINESS_HOURS = { start: 8, end: 20 }; // 08:00 - 20:00
        const SLOT_INTERVAL = 30; // 30åˆ†é˜ä¸€æ ¼

        // åˆå§‹åŒ–
        window.onload = function() {
            initDateScroller();
            loadUserProfile();
            loadSavedPhone();
        };

        // 1. åˆå§‹åŒ–æ—¥æœŸé¸æ“‡å™¨ (æœªä¾†7å¤©)
        function initDateScroller() {
            dom.dateScroller.innerHTML = '';
            for (let i = 0; i < 7; i++) {
                const date = dayjs().add(i, 'day');
                const isToday = i === 0;
                const dateStr = date.format('YYYY-MM-DD');
                const displayDay = date.format('MM/DD');
                const displayWeek = isToday ? 'ä»Šå¤©' : date.format('dddd').replace('é€±', '');

                const btn = document.createElement('button');
                btn.className = `flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center border-2 transition-all ${isToday ? 'border-blue-500 bg-blue-50 text-blue-600' : 'border-gray-100 bg-white text-gray-500'}`;
                btn.onclick = () => selectDate(dateStr, btn);
                btn.innerHTML = `
                    <span class="text-xs font-bold mb-1">${displayWeek}</span>
                    <span class="text-lg font-extrabold">${displayDay}</span>
                `;
                dom.dateScroller.appendChild(btn);
                
                // é è¨­é¸å–ä»Šå¤©
                if (isToday) selectDate(dateStr, btn);
            }
        }

        // 2. é¸å–æ—¥æœŸ
        async function selectDate(dateStr, btnElement) {
            // UI æ›´æ–°
            Array.from(dom.dateScroller.children).forEach(c => {
                c.classList.remove('border-blue-500', 'bg-blue-500', 'text-white', 'shadow-md');
                c.classList.add('border-gray-100', 'bg-white', 'text-gray-500');
                // å…§éƒ¨æ–‡å­—é¡è‰²é‡ç½®
                c.querySelector('span:first-child').classList.remove('text-blue-100');
            });
            
            // é¸ä¸­æ¨£å¼
            btnElement.classList.remove('border-gray-100', 'bg-white', 'text-gray-500');
            btnElement.classList.add('border-blue-500', 'bg-blue-500', 'text-white', 'shadow-md');
            btnElement.querySelector('span:first-child').classList.add('text-blue-100'); // æŠŠã€Œä»Šå¤©/é€±ä¸€ã€è®Šæ·¡è—è‰²

            dom.inputs.selectedDate.value = dateStr;
            dom.inputs.selectedTime.value = ''; // é‡ç½®æ™‚é–“
            updateSubmitButton();

            // è¼‰å…¥è©²æ—¥æœŸçš„æ™‚æ®µ
            await renderTimeSlots(dateStr);
        }

        // 3. æ¸²æŸ“æ™‚æ®µç¶²æ ¼
        async function renderTimeSlots(dateStr) {
            dom.timeGrid.innerHTML = '<div class="col-span-4 flex justify-center py-4"><div class="loader w-6 h-6 border-2 border-blue-400"></div></div>';
            
            // â˜…â˜…â˜… é€™è£¡æœªä¾†æ”¹ç‚º fetch GAS API â˜…â˜…â˜…
            // ç›®å‰ä½¿ç”¨ setTimeout æ¨¡æ“¬ç¶²è·¯å»¶é² + Mock Data
            await new Promise(r => setTimeout(r, 300)); 
            const busyList = MOCK_BUSY_SLOTS; 

            dom.timeGrid.innerHTML = '';
            
            const startHour = BUSINESS_HOURS.start;
            const endHour = BUSINESS_HOURS.end;
            const now = dayjs();
            const isToday = dateStr === now.format('YYYY-MM-DD');

            for (let h = startHour; h < endHour; h++) {
                for (let m = 0; m < 60; m += SLOT_INTERVAL) {
                    const timeStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    const fullTimeStr = `${dateStr} ${timeStr}`;
                    const slotTime = dayjs(fullTimeStr);
                    
                    let status = 'available'; // available, busy, past

                    // æª¢æŸ¥æ˜¯å¦éå»æ™‚é–“ (ç·©è¡ 30 åˆ†é˜)
                    if (isToday && slotTime.isBefore(now.add(30, 'minute'))) {
                        status = 'past';
                    }

                    // æª¢æŸ¥æ˜¯å¦å·²é ç´„ (æ¯”å° Mock Data)
                    if (busyList.includes(fullTimeStr)) {
                        status = 'busy';
                    }

                    createSlotButton(timeStr, status);
                }
            }
        }

        function createSlotButton(timeStr, status) {
            const btn = document.createElement('button');
            btn.className = 'slot-btn py-2 rounded-xl text-sm font-bold border transition-all duration-200';
            btn.innerText = timeStr;

            if (status === 'past' || status === 'busy') {
                btn.classList.add('disabled');
                btn.disabled = true;
                if(status === 'busy') btn.title = 'æ­¤æ™‚æ®µå·²é¡æ»¿';
            } else {
                btn.classList.add('bg-white', 'text-blue-600', 'border-blue-200', 'hover:border-blue-500');
                btn.onclick = () => selectTime(timeStr, btn);
            }
            dom.timeGrid.appendChild(btn);
        }

        // 4. é¸å–æ™‚é–“
        function selectTime(timeStr, btnElement) {
            // æ¸…é™¤å…¶ä»–é¸å–
            document.querySelectorAll('.slot-btn').forEach(b => {
                if (!b.disabled) {
                    b.classList.remove('selected');
                    b.classList.add('bg-white', 'text-blue-600');
                }
            });

            // é¸å–ç•¶å‰
            btnElement.classList.remove('bg-white', 'text-blue-600');
            btnElement.classList.add('selected');

            dom.inputs.selectedTime.value = timeStr;
            updateSubmitButton();
        }

        function updateSubmitButton() {
            const date = dom.inputs.selectedDate.value;
            const time = dom.inputs.selectedTime.value;
            
            if (date && time) {
                dom.btn.disabled = false;
                dom.btn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                dom.btn.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-blue-500', 'text-white', 'shadow-lg');
                dom.btn.innerHTML = `ç¢ºèªé ç´„ï¼š${dayjs(date).format('MM/DD')} ${time}`;
            } else {
                dom.btn.disabled = true;
                dom.btn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                dom.btn.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-blue-500', 'text-white', 'shadow-lg');
                dom.btn.innerHTML = 'è«‹å…ˆé¸æ“‡æ™‚é–“';
            }
        }

        // --- å…¶ä»–è¼”åŠ©åŠŸèƒ½ (ä¿ç•™åŸæœ¬é‚è¼¯) ---

        function loadUserProfile() {
            const liffId = "2008907691-v0O7W8d3"; // è¨˜å¾—ç¢ºèª ID
            liff.init({ liffId: liffId }).then(() => {
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    liff.getProfile().then(profile => {
                        dom.userDisplay.innerText = `Hi, ${profile.displayName}`;
                        dom.inputs.name.value = profile.displayName;
                        dom.loading.classList.add('hidden');
                        dom.app.classList.remove('hidden');
                    });
                }
            }).catch(err => {
                // æ–¹ä¾¿åœ¨é›»è…¦ç‰ˆæ¸¬è©¦
                dom.loading.classList.add('hidden');
                dom.app.classList.remove('hidden');
                console.error(err);
            });
        }
        
        function loadSavedPhone() {
            const saved = localStorage.getItem('taxi_user_phone');
            if (saved) dom.inputs.phone.value = saved;
        }

        // --- é ç´„é€å‡º ---
        async function confirmAndSubmit() {
            const date = dom.inputs.selectedDate.value;
            const time = dom.inputs.selectedTime.value;
            const pickup = dom.inputs.pickup.value;
            const dropoff = dom.inputs.dropoff.value;
            const phone = dom.inputs.phone.value;
            
            if (!pickup || !dropoff || !phone) {
                Swal.fire('è³‡æ–™ä¸å®Œæ•´', 'è«‹å¡«å¯«é›»è©±èˆ‡ä¸Šä¸‹è»Šåœ°é»', 'warning');
                return;
            }

            // äºŒæ¬¡ç¢ºèª
            const result = await Swal.fire({
                title: 'ç¢ºèªé ç´„å…§å®¹',
                html: `
                    <div class="text-left bg-gray-50 p-4 rounded-lg space-y-2 text-sm">
                        <p>ğŸ“… <strong>${date} ${time}</strong></p>
                        <p>ğŸ“ ${phone}</p>
                        <p>ğŸŸ¢ ${pickup}</p>
                        <p>ğŸ”´ ${dropoff}</p>
                        <p>ğŸ’° ${dom.inputs.payment.value}</p>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'âœ… ç¢ºå®šé€å‡º',
                cancelButtonText: 'å†æ”¹ä¸€ä¸‹',
                confirmButtonColor: '#2563eb'
            });

            if (result.isConfirmed) {
                // å„²å­˜é›»è©±
                localStorage.setItem('taxi_user_phone', phone);
                
                // 1. ç”¢ç”Ÿ Google æ—¥æ›†é€£çµ
                const startDateTime = dayjs(`${date} ${time}`).format('YYYYMMDDTHHmmss');
                const endDateTime = dayjs(`${date} ${time}`).add(30, 'minute').format('YYYYMMDDTHHmmss');
                const details = encodeURIComponent(`ä¹˜å®¢ï¼š${dom.inputs.name.value}\né›»è©±ï¼š${phone}\nä»˜æ¬¾ï¼š${dom.inputs.payment.value}`);
                const location = encodeURIComponent(pickup);
                const title = encodeURIComponent(`ğŸš• é ç´„ (${pickup} -> ${dropoff})`);
                
                const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startDateTime}/${endDateTime}&details=${details}&location=${location}`;

                // 2. LINE è¨Šæ¯å…§å®¹
                const msg = `ğŸ—“ï¸ æ–°å¢é ç´„\nğŸ“… ${date} ${time}\nğŸŸ¢ ${pickup}\nğŸ”´ ${dropoff}\nğŸ“ ${phone}`;

                if (liff.isInClient()) {
                    await liff.sendMessages([{ type: 'text', text: msg }]);
                    liff.closeWindow();
                } else {
                    // é›»è…¦ç‰ˆæˆ–å¤–éƒ¨ç€è¦½å™¨æ¸¬è©¦ç”¨
                    window.open(calendarUrl, '_blank');
                    Swal.fire('é ç´„æ¨¡æ“¬æˆåŠŸ', 'åœ¨ LIFF ä¸­æœƒç›´æ¥å‚³é€è¨Šæ¯ä¸¦é—œé–‰', 'success');
                }
            }
        }
        
        // --- å¸¸ç”¨åœ°é» (ä¿ç•™åŠŸèƒ½ä½†ç°¡åŒ–ä»£ç¢¼) ---
        const PRESET_LOCATIONS = [
            { name: 'å¸¸ç”¨åœ°å€ A', icon: 'â­', value: 'FAV_ADDR_A' },
            { name: 'èŠ±è“®è»Šç«™', icon: 'ğŸš‰' },
            { name: 'æ…ˆæ¿Ÿé†«é™¢', icon: 'ğŸ¥' },
             { name: 'é–€è«¾é†«é™¢', icon: 'ğŸ¥' }
        ];
        
        function openLocationPicker(inputId) {
            let html = '<div class="grid grid-cols-2 gap-2">';
            PRESET_LOCATIONS.forEach(loc => {
                html += `<button onclick="selectLoc('${inputId}', '${loc.value || loc.name}')" class="p-3 border rounded-lg hover:bg-blue-50 text-left">${loc.icon} ${loc.name}</button>`;
            });
            html += '</div>';
            Swal.fire({ title: 'å¿«é€Ÿé¸æ“‡', html: html, showConfirmButton: false });
        }
        
        window.selectLoc = (id, val) => {
            if(val === 'FAV_ADDR_A') {
                val = localStorage.getItem('taxi_fav_addr_a') || '';
                if(!val) return Swal.fire('å°šæœªè¨­å®š', 'è«‹å…ˆæ‰‹å‹•è¼¸å…¥ä¸€æ¬¡ä¸¦è¨˜æ†¶', 'info');
            }
            document.getElementById(id).value = val;
            Swal.close();
        }
    </script>
</body>
</html>
