<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‡ªåŠ©é ç´„æœå‹™</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-user-select: none; user-select: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; }
        /* éš±è—åŸç”Ÿ Time Input çš„å°åœ–æ¨™ï¼Œè®“é»æ“Šå€åŸŸæœ€å¤§åŒ– */
        input[type="time"]::-webkit-calendar-picker-indicator { background: transparent; bottom: 0; color: transparent; cursor: pointer; height: auto; left: 0; position: absolute; right: 0; top: 0; width: auto; }
        input[type="time"] { position: relative; }
        .date-btn.selected { background-color: #2563EB; color: white; border-color: #2563EB; }
        /* å¢åŠ æŒ‰éˆ•é»æ“Šçš„å›é¥‹æ„Ÿ */
        button:active { transform: scale(0.98); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen pb-10">

    <!-- Loading é®ç½© -->
    <div id="loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-xl font-bold text-gray-500">ç³»çµ±è¼‰å…¥ä¸­...</div>
    </div>

    <div class="max-w-md mx-auto bg-white min-h-screen shadow-lg">
        
        <!-- Row 1: ä¹˜å®¢æª”æ¡ˆ + æ­¡è¿è© -->
        <div class="p-6 bg-blue-600 text-white flex items-center space-x-4 shadow-md">
            <img id="userAvatar" src="https://via.placeholder.com/150" class="w-16 h-16 rounded-full border-2 border-white">
            <div>
                <p class="text-sm opacity-90">æ—©å®‰ï¼Œæ­¡è¿æ­ä¹˜</p>
                <h1 id="userName" class="text-2xl font-bold">è¼‰å…¥ä¸­...</h1>
            </div>
        </div>

        <form id="bookingForm" class="p-4 space-y-6">
            
            <!-- Row 2: è¦–è¦ºåŒ–æ—¥æœŸæŒ‰éˆ• -->
            <div>
                <label class="block text-lg font-bold text-gray-700 mb-2">ğŸ“… é¸æ“‡æ—¥æœŸ</label>
                <div id="dateContainer" class="grid grid-cols-4 gap-2">
                    <!-- JS è‡ªå‹•ç”¢ç”Ÿ -->
                </div>
                <input type="hidden" id="selectedDate" required>
            </div>

            <!-- Row 3: æ™‚é–“è¼¸å…¥ (Native Picker) -->
            <div>
                <label class="block text-lg font-bold text-gray-700 mb-2">â° é¸æ“‡æ™‚é–“</label>
                <div class="relative">
                    <input type="time" id="timeInput" required
                        class="w-full text-center text-4xl font-bold p-4 border-2 border-gray-300 rounded-xl bg-gray-50 focus:border-blue-500 focus:bg-white text-blue-600 h-24">
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none text-gray-400 text-sm mt-16">
                        é»æ“Šè¨­å®šæ™‚é–“
                    </div>
                </div>
            </div>

            <!-- Row 4: ä¸Šè»Šåœ°é» (è¨˜æ†¶ + å¿«é€ŸæŒ‰éˆ•) -->
            <div>
                <label class="block text-lg font-bold text-gray-700 mb-2">ğŸ“ ä¸Šè»Šåœ°é»</label>
                
                <div class="flex space-x-2 mb-3">
                    <button type="button" onclick="fillAddress('A')" id="btnA" class="flex-1 py-2 bg-gray-200 rounded-lg text-sm font-bold text-gray-600">å¸¸ç”¨ A</button>
                    <button type="button" onclick="fillAddress('B')" id="btnB" class="flex-1 py-2 bg-gray-200 rounded-lg text-sm font-bold text-gray-600">å¸¸ç”¨ B</button>
                    <button type="button" onclick="fillAddress('C')" id="btnC" class="flex-1 py-2 bg-gray-200 rounded-lg text-sm font-bold text-gray-600">å¸¸ç”¨ C</button>
                </div>

                <div class="relative">
                    <input type="text" id="addressInput" required placeholder="è«‹è¼¸å…¥æˆ–é¸æ“‡ä¸Šæ–¹åœ°é»"
                        class="w-full p-4 text-xl border-2 border-gray-300 rounded-xl focus:border-blue-500 outline-none">
                    <button type="button" onclick="saveCurrentAddress()" class="absolute right-2 top-2 bottom-2 px-4 bg-blue-100 text-blue-600 rounded-lg text-sm font-bold">
                        å­˜å…¥<br>å¸¸ç”¨
                    </button>
                </div>
            </div>

            <!-- Row 5: è¯çµ¡é›»è©± -->
            <div>
                <label class="block text-lg font-bold text-gray-700 mb-2">ğŸ“ è¯çµ¡é›»è©± <span class="text-sm font-normal text-gray-400">(é¸å¡«)</span></label>
                <input type="tel" id="phoneInput" placeholder="ä»£å«è»Šæ™‚æ‰éœ€å¡«å¯«"
                    class="w-full p-3 text-lg border-2 border-gray-300 rounded-xl focus:border-blue-500 outline-none">
            </div>

            <button type="submit" id="submitBtn" class="w-full py-5 bg-green-600 text-white text-2xl font-bold rounded-xl shadow-lg hover:bg-green-700">
                ç¢ºèªé ç´„
            </button>
        </form>
    </div>

    <!-- Modal: å„²å­˜åœ°é» -->
    <div id="saveModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-center">å­˜å…¥å“ªå€‹æŒ‰éˆ•ï¼Ÿ</h3>
            <div class="grid grid-cols-3 gap-3">
                <button onclick="confirmSave('A')" class="p-3 bg-gray-100 rounded-lg font-bold hover:bg-blue-100">ä½ç½® A</button>
                <button onclick="confirmSave('B')" class="p-3 bg-gray-100 rounded-lg font-bold hover:bg-blue-100">ä½ç½® B</button>
                <button onclick="confirmSave('C')" class="p-3 bg-gray-100 rounded-lg font-bold hover:bg-blue-100">ä½ç½® C</button>
            </div>
            <button onclick="document.getElementById('saveModal').classList.add('hidden')" class="mt-4 w-full py-2 text-gray-500">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // ==================== è¨­å®šå€ (è«‹ä¿®æ”¹é€™è£¡) ====================
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwODDCmwAggIyan3gxJJazGd3fWR9N2JsBk04OBQfyQ6SPjduhbQIEg_B_GZWH2Uex7/exec';
        const LIFF_ID = '2008907691-x4s1XueL';
        // ========================================================

        let profile = null;

        window.onload = async function() {
            initDateButtons();
            loadSavedAddresses();
            
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    profile = await liff.getProfile();
                    document.getElementById('userName').innerText = profile.displayName;
                    document.getElementById('userAvatar').src = profile.pictureUrl || 'https://via.placeholder.com/150';
                    document.getElementById('loading').style.display = 'none';
                }
            } catch (err) {
                alert('åˆå§‹åŒ–éŒ¯èª¤: ' + err);
                document.getElementById('loading').style.display = 'none';
            }
        };

        function initDateButtons() {
            const container = document.getElementById('dateContainer');
            const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const today = new Date();

            for (let i = 0; i < 8; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                const month = d.getMonth() + 1;
                const date = d.getDate();
                const day = weekDays[d.getDay()];
                const dateVal = d.toISOString().split('T')[0];
                
                const btnText = i === 0 ? `ä»Šå¤©<br>${month}/${date}` : `${month}/${date}<br>(${day})`;
                const btn = document.createElement('div');
                btn.className = `date-btn cursor-pointer border-2 border-gray-200 rounded-lg p-2 text-center text-gray-600 bg-white`;
                btn.innerHTML = `<span class="text-sm font-bold leading-tight pointer-events-none">${btnText}</span>`;
                btn.onclick = () => {
                    document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    document.getElementById('selectedDate').value = dateVal;
                };
                container.appendChild(btn);
                if (i === 0) btn.click();
            }
        }

        function loadSavedAddresses() {
            ['A', 'B', 'C'].forEach(key => {
                const addr = localStorage.getItem('addr_' + key);
                if (addr) {
                    document.getElementById('btn' + key).innerText = addr.substring(0, 3) + '...';
                    document.getElementById('btn' + key).classList.add('bg-blue-100', 'text-blue-700');
                }
            });
        }

        function fillAddress(key) {
            const addr = localStorage.getItem('addr_' + key);
            if (addr) document.getElementById('addressInput').value = addr;
            else alert('æ­¤æŒ‰éˆ•å°šæœªè¨­å®šåœ°å€');
        }

        function saveCurrentAddress() {
            if(!document.getElementById('addressInput').value) return alert('è«‹å…ˆè¼¸å…¥åœ°å€');
            document.getElementById('saveModal').classList.remove('hidden');
        }

        function confirmSave(key) {
            const val = document.getElementById('addressInput').value;
            localStorage.setItem('addr_' + key, val);
            loadSavedAddresses();
            document.getElementById('saveModal').classList.add('hidden');
        }

        document.getElementById('bookingForm').onsubmit = async function(e) {
            e.preventDefault();
            
            const btn = document.getElementById('submitBtn');
            const date = document.getElementById('selectedDate').value;
            const time = document.getElementById('timeInput').value;
            
            if(!date || !time) return alert('è«‹é¸æ“‡æ—¥æœŸèˆ‡æ™‚é–“');
            
            btn.disabled = true;
            btn.innerText = 'æ­£åœ¨é ç´„...';
            btn.classList.add('bg-gray-400');

            const payload = {
                action: 'book',
                userId: profile.userId,
                userName: profile.displayName,
                startTime: `${date}T${time}:00`,
                pickupLoc: document.getElementById('addressInput').value,
                phone: document.getElementById('phoneInput').value
            };

            try {
                // ä½¿ç”¨ fetch ç™¼é€è«‹æ±‚åˆ° GAS
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                const data = await res.json();

                if (data.status === 'success') {
                    // å³ä½¿ lineStatus æ˜¯ failed_but_bookedï¼Œæˆ‘å€‘ä¹Ÿé¡¯ç¤ºæˆåŠŸ
                    // å› ç‚ºå°ä¹˜å®¢ä¾†èªªï¼Œæ—¥æ›†æœ‰å¯«é€²å»æœ€é‡è¦
                    liff.closeWindow(); 
                } else {
                    alert('âŒ é ç´„å¤±æ•—ï¼š' + data.message);
                    resetBtn();
                }
            } catch (err) {
                // é€™è£¡é€šå¸¸ä¸æœƒè·‘åˆ°ï¼Œå› ç‚ºå¾Œç«¯ç¾åœ¨ä¸€å®šæœƒå›å‚³ JSON
                alert('ç³»çµ±é€£ç·šç•°å¸¸ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚' + err);
                resetBtn();
            }
        };

        function resetBtn() {
            const btn = document.getElementById('submitBtn');
            btn.disabled = false;
            btn.innerText = 'ç¢ºèªé ç´„';
            btn.classList.remove('bg-gray-400');
        }
    </script>
</body>
</html>
