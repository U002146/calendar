<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>預約排程</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 長輩友善優化 */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; touch-action: manipulation; }
        .btn-date { transition: all 0.2s; }
        .btn-date.active { background-color: #06c755; color: white; border-color: #06c755; transform: scale(1.05); }
        .input-large { font-size: 1.2rem; padding: 0.75rem; }
        
        /* 隱藏預設的時間選擇器圖示，改用我們自己的大樣式 */
        input[type="time"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0; color: transparent; cursor: pointer;
            height: auto; left: 0; position: absolute; right: 0; top: 0; width: auto;
        }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 50;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-10">

    <!-- 標題區 -->
    <div class="bg-[#06c755] p-4 text-white text-center shadow-md">
        <h1 class="text-xl font-bold tracking-wider">預約排程</h1>
        <p class="text-sm opacity-90 mt-1">請選擇日期與時間</p>
    </div>

    <div class="max-w-md mx-auto p-4 space-y-6">

        <!-- 區塊 1: 日期選擇 -->
        <div class="bg-white rounded-xl shadow p-4">
            <h2 class="text-lg font-bold text-gray-700 mb-3 border-l-4 border-[#06c755] pl-3">1. 選擇日期</h2>
            <!-- 日期按鈕區 -->
            <div id="date-container" class="grid grid-cols-4 gap-2 mb-4">
                <!-- JS 生成按鈕 -->
            </div>
            
            <!-- 簡易日曆/忙碌時段顯示 -->
            <div class="bg-gray-100 rounded-lg p-3 text-center">
                <p class="text-gray-500 text-sm mb-2">當日已預約時段 (司機忙碌中)</p>
                <div id="busy-slots" class="flex flex-wrap gap-2 justify-center text-sm text-red-500 font-medium min-h-[1.5rem]">
                    <span class="text-gray-400">請先選擇日期...</span>
                </div>
            </div>
        </div>

        <!-- 區塊 2: 詳細資料 -->
        <div class="bg-white rounded-xl shadow p-4 space-y-5">
            <h2 class="text-lg font-bold text-gray-700 mb-2 border-l-4 border-[#06c755] pl-3">2. 填寫資料</h2>

            <!-- 第三列: 時間選擇 -->
            <div class="relative">
                <label class="block text-gray-700 font-bold mb-1 text-lg">上車時間</label>
                <div class="relative w-full h-14 bg-white border-2 border-gray-300 rounded-lg flex items-center px-3 overflow-hidden">
                    <i class="fas fa-clock text-gray-400 text-xl mr-3"></i>
                    <input type="time" id="time-input" class="w-full h-full text-2xl font-bold text-gray-800 bg-transparent focus:outline-none" required>
                </div>
                <p class="text-xs text-gray-500 mt-1">*點擊上方框框選擇時間</p>
            </div>

            <!-- 第四列: 上車地點 (含記憶功能) -->
            <div>
                <label class="block text-gray-700 font-bold mb-1 text-lg">
                    上車地點 <span class="text-red-500">*</span>
                </label>
                <div class="flex gap-2">
                    <input type="text" id="location-input" placeholder="例如: 花蓮火車站" class="flex-1 border-2 border-gray-300 rounded-lg p-3 text-lg focus:border-[#06c755] focus:outline-none">
                    <button onclick="openFavModal()" class="bg-yellow-400 hover:bg-yellow-500 text-white rounded-lg px-4 shadow active:scale-95 transition">
                        <i class="fas fa-star text-xl"></i>
                    </button>
                </div>
                
                <!-- 快速選擇按鈕 -->
                <div class="flex gap-2 mt-2">
                    <button onclick="loadFav('A')" class="flex-1 bg-gray-200 py-2 rounded text-gray-700 font-bold hover:bg-gray-300 transition">A</button>
                    <button onclick="loadFav('B')" class="flex-1 bg-gray-200 py-2 rounded text-gray-700 font-bold hover:bg-gray-300 transition">B</button>
                    <button onclick="loadFav('C')" class="flex-1 bg-gray-200 py-2 rounded text-gray-700 font-bold hover:bg-gray-300 transition">C</button>
                </div>
            </div>

            <!-- 第五列: 聯絡電話 -->
            <div>
                <label class="block text-gray-700 font-bold mb-1 text-lg">聯絡電話 (選填)</label>
                <input type="tel" id="phone-input" placeholder="代叫車時請填寫" class="w-full border-2 border-gray-300 rounded-lg p-3 text-lg focus:border-[#06c755] focus:outline-none">
            </div>
        </div>

        <!-- 送出按鈕 -->
        <button id="submit-btn" onclick="submitBooking()" class="w-full bg-[#06c755] hover:bg-[#05b34c] text-white text-2xl font-bold py-4 rounded-xl shadow-lg transform transition active:scale-95">
            確認預約
        </button>

        <div class="text-center text-gray-400 text-xs mt-4">
            系統開發: 花蓮在地科技運將 v2.0
        </div>
    </div>

    <!-- 彈出視窗: 設定常用地址 -->
    <div id="fav-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 relative">
            <h3 class="text-xl font-bold mb-4 text-center">設定常用地點</h3>
            <button onclick="closeFavModal()" class="absolute top-4 right-4 text-gray-400 text-xl"><i class="fas fa-times"></i></button>
            
            <div class="space-y-4">
                <div>
                    <label class="block font-bold text-gray-600">地點 A</label>
                    <div class="flex gap-2">
                        <input type="text" id="fav-input-A" class="flex-1 border rounded p-2">
                        <button onclick="saveFav('A')" class="bg-blue-500 text-white px-3 rounded">儲存</button>
                    </div>
                </div>
                <div>
                    <label class="block font-bold text-gray-600">地點 B</label>
                    <div class="flex gap-2">
                        <input type="text" id="fav-input-B" class="flex-1 border rounded p-2">
                        <button onclick="saveFav('B')" class="bg-blue-500 text-white px-3 rounded">儲存</button>
                    </div>
                </div>
                <div>
                    <label class="block font-bold text-gray-600">地點 C</label>
                    <div class="flex gap-2">
                        <input type="text" id="fav-input-C" class="flex-1 border rounded p-2">
                        <button onclick="saveFav('C')" class="bg-blue-500 text-white px-3 rounded">儲存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading 動畫 -->
    <div id="loading" class="loading-overlay">
        <div class="text-center text-white">
            <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
            <p class="text-xl font-bold">預約處理中...</p>
        </div>
    </div>

    <script>
        // 設定: 請填入你的 GAS Web App URL
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwODDCmwAggIyan3gxJJazGd3fWR9N2JsBk04OBQfyQ6SPjduhbQIEg_B_GZWH2Uex7/exec';
        // 設定: LIFF ID
        const LIFF_ID = '2008907691-x4s1XueL';

        let selectedDate = null;
        let userProfile = null;

        // 初始化
        window.onload = function() {
            initDateButtons();
            loadFavsToModal();
            
            // LIFF 初始化
            // liff.init({ liffId: LIFF_ID }).then(() => {
            //     if (liff.isLoggedIn()) {
            //         liff.getProfile().then(profile => userProfile = profile);
            //     } else {
            //         liff.login();
            //     }
            // }).catch(err => console.error(err));
            
            // 模擬資料 (開發用，上線請取消註解上方 LIFF 程式碼)
             userProfile = { displayName: '測試乘客', userId: 'U12345678' };
        };

        // 1. 初始化日期按鈕 (今天 + 3天)
        function initDateButtons() {
            const container = document.getElementById('date-container');
            const today = new Date();
            const weekDays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];

            for (let i = 0; i < 4; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const week = weekDays[date.getDay()];
                const dateStr = `${date.getFullYear()}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const btn = document.createElement('button');
                btn.className = `btn-date border-2 border-gray-200 rounded-lg py-2 flex flex-col items-center justify-center bg-white`;
                btn.innerHTML = `
                    <span class="text-xs font-bold ${i === 0 ? 'text-red-500' : 'text-gray-500'}">${i === 0 ? '今天' : week}</span>
                    <span class="text-xl font-bold text-gray-800">${month}/${day}</span>
                `;
                btn.onclick = () => selectDate(btn, dateStr);
                container.appendChild(btn);
                
                // 預設選取今天
                if (i === 0) selectDate(btn, dateStr);
            }
        }

        function selectDate(btn, dateStr) {
            // UI 更新
            document.querySelectorAll('.btn-date').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedDate = dateStr;

            // 這裡可以呼叫後端 API 查詢該日期的忙碌時段 (v2.1 功能)
            // fetchBusySlots(dateStr); 
            document.getElementById('busy-slots').innerHTML = '<span class="text-gray-400">查詢中...</span>';
            // 模擬查詢延遲
            setTimeout(() => {
                 document.getElementById('busy-slots').innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle"></i> 目前全天皆可預約</span>';
            }, 500);
        }

        // 2. 常用地點功能 (LocalStorage)
        function openFavModal() {
            document.getElementById('fav-modal').classList.remove('hidden');
        }
        function closeFavModal() {
            document.getElementById('fav-modal').classList.add('hidden');
        }
        
        function saveFav(slot) {
            const val = document.getElementById(`fav-input-${slot}`).value;
            if(!val) return alert('請輸入地址');
            localStorage.setItem(`taxi_fav_${slot}`, val);
            alert(`已儲存到常用地點 ${slot}`);
            closeFavModal();
        }

        function loadFavsToModal() {
            ['A', 'B', 'C'].forEach(slot => {
                const val = localStorage.getItem(`taxi_fav_${slot}`);
                if (val) document.getElementById(`fav-input-${slot}`).value = val;
            });
        }

        function loadFav(slot) {
            const val = localStorage.getItem(`taxi_fav_${slot}`);
            if (val) {
                document.getElementById('location-input').value = val;
            } else {
                alert(`尚未設定地點 ${slot}，請按星號設定。`);
            }
        }

        // 3. 送出預約
        function submitBooking() {
            const time = document.getElementById('time-input').value;
            const location = document.getElementById('location-input').value;
            const phone = document.getElementById('phone-input').value;

            // 驗證
            if (!selectedDate || !time || !location) {
                // 使用 LIFF 內建的 alert 或是簡易 alert
                return alert('請完整填寫：日期、時間、上車地點');
            }

            const bookingData = {
                action: 'book',
                userId: userProfile ? userProfile.userId : 'GUEST',
                displayName: userProfile ? userProfile.displayName : '乘客',
                date: selectedDate,
                time: time,
                location: location,
                phone: phone
            };

            document.getElementById('loading').style.display = 'flex';

            // 這裡應該是 fetch 到 GAS
            // 由於這是演示，我們用 setTimeout 模擬
            console.log("Sending to GAS:", bookingData);

            /* fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify(bookingData)
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                if(data.success) {
                    alert('預約成功！');
                    liff.closeWindow();
                } else {
                    alert('預約失敗：' + data.message);
                }
            });
            */
           
           // 模擬後端回應
           setTimeout(() => {
               document.getElementById('loading').style.display = 'none';
               // 成功案例
               alert('✅ 預約成功！\n\n時間：' + selectedDate + ' ' + time + '\n地點：' + location + '\n\n系統已發送確認單至聊天室。');
               // liff.closeWindow();
           }, 1500);
        }

    </script>
</body>
</html>
